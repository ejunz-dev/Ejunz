{% extends "layout/basic.html" %}

<script>
  {{ set(UiContext, {
    ddoc: ddoc,
    docs: docs,
    repos: repos,
    resources: resources
  }) }}
</script>

{% block content %}
<div class="row">
  <div class="medium-9 columns">
    <div class="section">
      <div class="section__header">
        <h2 class="section__title">{{ _("Branch Details") }}</h2>
      </div>
      <div class="section__body">
        {% if ddoc %}
          <h3>{{ _("Branch Title") }}: {{ ddoc.title }}</h3>
          <p><strong>{{ _("Branch ID") }}:</strong> {{ ddoc.bid }}</p>

          <!-- 🔥 Markdown 渲染 Branch 内容 -->
          <div class="section">
            <div class="section__header">
              <h3>{{ _("Branch Content") }}</h3>
            </div>
            <div class="section__body">
              {% if ddoc.content %}
                <div class="typo richmedia topic__content" data-emoji-enabled>
                  {{ ddoc.content|markdown|safe }}
                </div>
              {% else %}
                <p>{{ _("No content available.") }}</p>
              {% endif %}
            </div>
          </div>
          <!-- ✅ Markdown 渲染部分结束 -->

          <div class="section">
            <div class="section__header">
              <h3>{{ _("Branch Map") }}</h3>
            </div>
            <div class="section__body">
              {% if branchHierarchy and branchHierarchy.trunk %}
                
                {% macro render_tree(branches, level=0, prefix="") %}
                {% if branches and branches|length > 0 %}
                  <div style="display: flex; justify-content: center; align-items: flex-end; gap: 50px; {% if level == 0 %}flex-wrap: wrap;{% endif %}">

                    {% for branch in branches if branch.bid != branchHierarchy.trunk.bid %}
                      <div style="text-align: center; position: relative;">
                        {% if branch.subBranches and branch.subBranches|length > 0 %}
                          <div style="display: flex; flex-direction: column-reverse; align-items: center;">
                            {{ render_tree(branch.subBranches, level + 1, prefix + "    ") }}
                          </div>
                        {% endif %}
                        <div>
                          {% if branch.subBranches and branch.subBranches|length > 0 %} 🌿 {% else %} 🌱 {% endif %}
                          <a href="{{ url('branch_detail', domainId=ddoc.domainId, docId=branch.docId) }}">
                            {{ branch.title }}
                          </a>
                        </div>
                        <div>{{ prefix }}*</div>
                      </div>
                    {% endfor %}
                  </div>

                  {% if level == 0 and branchHierarchy.trunk %}
                    <div style="display: flex; justify-content: center; margin-top: 20px;">
                      <div style="text-align: center;">
                        🌳
                        <a href="{{ url('branch_detail', domainId=ddoc.domainId, docId=branchHierarchy.trunk.docId) }}">
                          {{ branchHierarchy.trunk.title }}
                        </a>
                      </div>
                    </div>
                  {% endif %}
                {% endif %}
              {% endmacro %}

              <div style="display: flex; flex-direction: column; align-items: center;">
                {% if branchHierarchy and branchHierarchy.trunk %}
                  {{ render_tree(branchHierarchy.branches) }}
                {% else %}
                  <p>{{ _("No branches available.") }}</p>
                {% endif %}
              </div>

              {% else %}
                <p>{{ _("No branches available.") }}</p>
              {% endif %}
            </div>
          </div>

        {% else %}
          <p>{{ _("Branch not found.") }}</p>
        {% endif %}
      </div>
    
    </div>
  </div>
  <div class="medium-3 columns">
    <div class="section">
      <div class="section__header">
        <a href="{{ url('branch_edit', domainId=ddoc.domainId, docId=ddoc.docId) }}" class="button primary expanded">
          {{ _('Edit Content') }}
        </a>
      </div>
    </div>
  </div>
</div>
{% endblock %}
