{% extends "layout/basic.html" %}

{% block title %}{{ _('MCP Provider Logs') }}{% endblock %}

{% block content %}
<div class="row">
  <div class="medium-12 columns">
    <div class="section">
      <div class="section__header">
        <h1 class="section__title">{{ _('MCP Provider Real-time Logs') }}</h1>
        <div class="section__tools">
          <button id="clearLogs" class="button">Clear Logs</button>
          <button id="scrollLock" class="button">ðŸ”’ Lock Scroll</button>
        </div>
      </div>
      
      <div class="section__body">
        <div class="log-container" id="logContainer">
          {% for log in logs %}
          <div class="log-entry" data-level="{{ log.level }}">
            <span class="log-time">[{{ log.time }}]</span>
            <span class="log-level log-{{ log.level }}">{{ log.level }}</span>
            <span class="log-message">{{ log.message }}</span>
          </div>
          {% endfor %}
        </div>
      </div>
    </div>
  </div>
</div>

<style>
.log-container {
    background: #1e1e1e;
    color: #d4d4d4;
    padding: 16px;
    border-radius: 8px;
    font-family: 'Courier New', monospace;
    font-size: 14px;
    line-height: 1.6;
    max-height: 70vh;
    overflow-y: auto;
    overflow-x: auto;
}

.log-entry {
    display: flex;
    padding: 4px 0;
    border-bottom: 1px solid #2d2d2d;
}

.log-entry:hover {
    background: rgba(255, 255, 255, 0.05);
}

.log-time {
    color: #858585;
    margin-right: 12px;
    min-width: 200px;
}

.log-level {
    margin-right: 12px;
    min-width: 80px;
    font-weight: bold;
    text-transform: uppercase;
}

.log-info {
    color: #4ec9b0;
}

.log-error {
    color: #f48771;
}

.log-warn {
    color: #dcdcaa;
}

.log-debug {
    color: #9cdcfe;
}

.log-message {
    flex: 1;
    word-break: break-word;
}

.section__header {
    display: flex;
    align-items: center;
    justify-content: space-between;
}

.section__tools {
    display: flex;
    gap: 8px;
}

.button {
    padding: 8px 16px;
    background: #007acc;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    transition: background 0.2s;
}

.button:hover {
    background: #005999;
}

.button.active {
    background: #00a5d5;
}
</style>

<script>
(function() {
    const container = document.getElementById('logContainer');
    const clearBtn = document.getElementById('clearLogs');
    const lockBtn = document.getElementById('scrollLock');
    let scrollLocked = true;
    let ws = null;

    function connectWebSocket() {
        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const wsUrl = `${protocol}//${window.location.host}/mcp/ws`;
        
        ws = new WebSocket(wsUrl);
        
        ws.onopen = () => {
            addLogEntry({
                time: new Date().toISOString(),
                level: 'info',
                message: 'WebSocket connected'
            });
        };
        
        ws.onmessage = (event) => {
            const data = JSON.parse(event.data);
            
            if (data.type === 'history') {
                container.innerHTML = '';
                data.logs.forEach(log => addLogEntry(log));
            } else if (data.type === 'log') {
                addLogEntry(data.data);
            }
        };
        
        ws.onerror = (error) => {
            addLogEntry({
                time: new Date().toISOString(),
                level: 'error',
                message: 'WebSocket connection error'
            });
        };
        
        ws.onclose = (event) => {
            addLogEntry({
                time: new Date().toISOString(),
                level: 'warn',
                message: 'WebSocket disconnected, reconnecting in 3 seconds...'
            });
            setTimeout(connectWebSocket, 3000);
        };
    }
    
    function addLogEntry(log) {
        const entry = document.createElement('div');
        entry.className = 'log-entry';
        entry.setAttribute('data-level', log.level);
        
        entry.innerHTML = `
            <span class="log-time">[${log.time}]</span>
            <span class="log-level log-${log.level}">${log.level}</span>
            <span class="log-message">${log.message}</span>
        `;
        
        container.appendChild(entry);
        
        if (scrollLocked) {
            container.scrollTop = container.scrollHeight;
        }
        
        while (container.children.length > 1000) {
            container.removeChild(container.firstChild);
        }
    }
    
    clearBtn.addEventListener('click', () => {
        container.innerHTML = '';
    });
    
    lockBtn.addEventListener('click', () => {
        scrollLocked = !scrollLocked;
        lockBtn.classList.toggle('active', scrollLocked);
        lockBtn.textContent = scrollLocked ? 'Lock Scroll' : 'Free Scroll';
        
        if (scrollLocked) {
            container.scrollTop = container.scrollHeight;
        }
    });
    
    connectWebSocket();
})();
</script>
{% endblock %}
