{% set page_name = "mcp_domain" %}
{% extends "layout/basic.html" %}
{% block content %}
<div class="row">
    <div class="columns">
        <div class="section">
            <div class="section__header">
                <h1 class="section__title">MCP 服务器管理</h1>
                <div class="section__action">
                    {% if handler.user.hasPriv(model.builtin.PRIV.PRIV_USER_PROFILE) %}
                        <a href="{{ url('mcp_create', { domainId: domainId }) }}" class="button primary">{{ _('Create MCP Server') }}</a>
                    {% endif %}
                </div>
            </div>
            <div class="section__body">
                <div class="mcp-endpoint-info">
                    <h3>WebSocket 接入点</h3>
                    <p>MCP 服务器可以通过以下 WebSocket URL 连接（需要先为服务器生成 Token）：</p>
                    <div class="endpoint-url">
                        <code id="mcp-endpoint-base">{{ wsEndpointBase }}?token=YOUR_TOKEN</code>
                        <button class="button small mcp-copy-base-endpoint-btn">复制</button>
                    </div>
                    <div class="endpoint-instructions">
                        <h4>使用步骤：</h4>
                        <ol>
                            <li>在服务器详情页面生成 Token</li>
                            <li>使用生成的 Token 连接到上述 WebSocket URL</li>
                            <li>连接成功后，可以发送工具列表：<code>{"type": "tools/list", "tools": [...]}</code></li>
                        </ol>
                    </div>
                </div>
                
                {% if servers and servers.length > 0 %}
                    <div class="mcp-server-list">
                        <h3>已接入的 MCP 服务器</h3>
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>服务器名称</th>
                                    <th>类型</th>
                                    <th>状态</th>
                                    <th>工具数量</th>
                                    <th>最后连接</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for server in servers %}
                                    <tr>
                                        <td>
                                            <a href="{{ url('mcp_detail', { domainId: domainId, serverId: server.serverId }) }}">
                                                {{ server.name }}
                                            </a>
                                            {% if server.description %}
                                                <br><small class="text-gray">{{ server.description }}</small>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% set serverType = server.type|default('provider') %}
                                            {% if serverType == 'repo' %}
                                                <span class="badge badge--primary">Repo</span>
                                            {% elif serverType == 'node' %}
                                                <span class="badge badge--info">Node</span>
                                            {% else %}
                                                <span class="badge">Provider</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <span class="server-status server-status-{{ server.status }}">
                                                {% if server.status == 'connected' %}
                                                    已连接
                                                {% elif server.status == 'disconnected' %}
                                                    已断开
                                                {% elif server.status == 'error' %}
                                                    错误
                                                {% else %}
                                                    {{ server.status }}
                                                {% endif %}
                                            </span>
                                        </td>
                                        <td>{{ server.toolsCount|default(0) }}</td>
                                        <td>
                                            {% if server.lastConnectedAt %}
                                                {{ datetimeSpan(server.lastConnectedAt)|safe }}
                                            {% else %}
                                                -
                                            {% endif %}
                                        </td>
                                        <td>
                                            <a href="{{ url('mcp_detail', { domainId: domainId, serverId: server.serverId }) }}" class="button small">查看详情</a>
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <div class="mcp-empty-message">
                        <p>暂无已接入的 MCP 服务器。</p>
                        <p>使用上述 WebSocket 接入点连接 MCP 服务器后，它们将自动显示在这里。</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

