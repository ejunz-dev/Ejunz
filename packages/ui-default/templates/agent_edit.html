{% import "components/form.html" as form with context %}
{% extends "layout/basic.html" %}
{% block content %}
<div class="row">
  <div class="medium-9 columns">
    <div class="section">
      <div class="section__body">
        <form method="post">
          <div class="row">
            <div class="medium-12 columns">
              <label>
                {{ _('Agentname') }}
                <input 
                  name="title" 
                  placeholder="{{ _('Enter agent title') }}"
                  value="{{ adoc.title|default('') }}" 
                  class="textbox" 
                  required 
                  autofocus>
              </label>
            </div>
          </div>

          {{ form.form_textarea({
                columns: 12,
                label: _('Content'),
                name: 'content',
                value: adoc.content|default(''),
                hotkeys: 'ctrl+enter:submit',
                markdown: true,
                required: true,
                extra_style: 'height: 500px',
                extra_textarea_class: 'auto-resize',
                id: 'content-textarea'
              }) }}

          {{ form.form_text({
               row: false,
               columns: 9,
               label: _('Tags'),
               help_text: _('Split by \', \'.'),
               name: 'tag',
               value: adoc['tag']|default([])|join(', ')
             }) }}

          {{ form.form_textarea({
                columns: 12,
                label: _('Memory'),
                name: 'memory',
                value: adoc.memory|default(''),
                help_text: _('Agent工作规则记忆：记录工具使用规则、用户指导和工作方式。系统会在每次对话后自动更新。'),
                markdown: false,
                required: false,
                extra_style: 'height: 200px'
              }) }}

          <!-- Repo Selection -->
          <div class="row" style="margin-top: 20px;">
            <div class="medium-12 columns">
              <label>
                {{ _('Repos') }}
                <p class="help-text" style="margin-top: 5px; margin-bottom: 10px;">
                  {{ _('Select repos to enable for this agent. MCP tools from selected repos will be automatically available.') }}
                </p>
                
                {% if allRepos and allRepos.length > 0 %}
                <div style="max-height: 300px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; border-radius: 4px; background: #f9f9f9;">
                  {% for repo in allRepos %}
                  <div class="repo-item" style="margin-bottom: 10px; padding: 10px; border: 1px solid #eee; border-radius: 4px; background: white;">
                    <label style="display: flex; align-items: center; cursor: pointer;">
                      <input type="checkbox" 
                             name="repoIds" 
                             value="{{ repo.rpid }}" 
                             {% if repo.rpid|string in assignedRepoIds or repo.rpid in assignedRepoIds %}checked{% endif %}
                             style="margin-right: 10px;">
                      <div style="flex: 1;">
                        <div style="font-weight: bold;">
                          {{ repo.title }}
                          <span style="font-size: 0.85em; color: #666; font-weight: normal;">(ID: {{ repo.rpid }})</span>
                        </div>
                        {% if repo.mcpServerId %}
                        <div style="font-size: 0.85em; color: #666; margin-top: 3px;">
                          <span class="badge badge--success">{{ _('MCP Enabled') }}</span>
                        </div>
                        {% else %}
                        <div style="font-size: 0.85em; color: #999; margin-top: 3px;">
                          <span class="badge">{{ _('No MCP Server') }}</span>
                        </div>
                        {% endif %}
                      </div>
                    </label>
                  </div>
                  {% endfor %}
                </div>
                {% else %}
                <p class="note" style="margin-top: 10px;">
                  {{ _('No repos available. Please create repos first.') }}
                </p>
                {% endif %}
              </label>
            </div>
          </div>

          <!-- MCP Tools Assignment -->
          <div class="row" style="margin-top: 20px;">
            <div class="medium-12 columns">
              <label>
                {{ _('MCP Tools') }}
                <p class="help-text" style="margin-top: 5px; margin-bottom: 10px;">
                  {{ _('Select MCP tools by category: Provider (external MCP services), Node (node-provided tools), or Repo (repo-specific tools).') }}
                </p>
                
                <!-- Provider MCP Tools -->
                <div style="margin-bottom: 20px;">
                  <h3 style="font-size: 1.1em; margin-bottom: 10px;">{{ _('Provider (External MCP Services)') }}</h3>
                  {% if providerServers and providerServers.length > 0 %}
                  <div style="max-height: 400px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; border-radius: 4px; background: #f9f9f9;">
                    {% for server in providerServers %}
                    <div class="mcp-server-group" style="margin-bottom: 15px; padding: 10px; border: 1px solid #ddd; border-radius: 4px; background: white;">
                      <label style="display: flex; align-items: center; cursor: pointer; margin-bottom: 10px;">
                        <input type="checkbox" 
                               class="server-select-all" 
                               data-server-id="{{ server.serverId }}"
                               data-type="provider"
                               style="margin-right: 10px;">
                        <div style="flex: 1; font-weight: bold;">
                          {{ server.serverName }}
                          <span style="font-size: 0.85em; color: #666; font-weight: normal;">
                            ({{ server.tools|length }} {{ _('tools') }})
                          </span>
                          {% if server.status == 'connected' %}
                          <span class="badge badge--success" style="margin-left: 5px;">{{ _('Online') }}</span>
                          {% else %}
                          <span class="badge" style="margin-left: 5px;">{{ _('Offline') }}</span>
                          {% endif %}
                        </div>
                        <button type="button" class="button" onclick="toggleServerTools('provider-{{ server.serverId }}')" style="font-size: 0.85em;">
                          <span id="toggle-provider-{{ server.serverId }}">▶</span> {{ _('Expand') }}
                        </button>
                      </label>
                      <div id="provider-{{ server.serverId }}" style="display: none; margin-left: 25px;">
                        {% for tool in server.tools %}
                        <div class="tool-item" style="margin-bottom: 8px; padding: 8px; border: 1px solid #eee; border-radius: 3px; background: #fafafa;">
                          <label style="display: flex; align-items: flex-start; cursor: pointer;">
                            <input type="checkbox" 
                                   name="toolIds" 
                                   value="{{ tool._id.toString() }}" 
                                   class="tool-checkbox"
                                   data-server-id="{{ server.serverId }}"
                                   {% if tool._id.toString() in assignedToolIds %}checked{% endif %}
                                   style="margin-right: 10px; margin-top: 3px;">
                            <div style="flex: 1;">
                              <div style="font-weight: bold; margin-bottom: 3px; font-size: 0.9em;">
                                {{ tool.name }}
                              </div>
                              <div style="font-size: 0.85em; color: #666; margin-bottom: 3px;">
                                {{ tool.description }}
                              </div>
                              {% if tool.inputSchema %}
                              <details style="font-size: 0.8em; color: #888;">
                                <summary style="cursor: pointer;">{{ _('View Parameters') }}</summary>
                                <pre style="margin-top: 5px; padding: 5px; background: #f5f5f5; border-radius: 3px; overflow-x: auto; font-size: 0.75em;">{{ tool.inputSchema|json }}</pre>
                              </details>
                              {% endif %}
                            </div>
                          </label>
                        </div>
                        {% endfor %}
                      </div>
                    </div>
                    {% endfor %}
                  </div>
                  {% else %}
                  <p class="note" style="margin-top: 10px;">{{ _('No provider MCP servers available.') }}</p>
                  {% endif %}
                </div>

                <!-- Repo MCP Tools -->
                {% if repoServers and repoServers.length > 0 %}
                <div style="margin-bottom: 20px;">
                  <h3 style="font-size: 1.1em; margin-bottom: 10px;">{{ _('Repo (Repo-Specific Tools)') }}</h3>
                  <div style="max-height: 400px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; border-radius: 4px; background: #f9f9f9;">
                    {% for server in repoServers %}
                    <div class="mcp-repo-group" style="margin-bottom: 15px; padding: 10px; border: 1px solid #ddd; border-radius: 4px; background: white;">
                      <label style="display: flex; align-items: center; cursor: pointer; margin-bottom: 10px;">
                        <input type="checkbox" 
                               class="repo-select-all" 
                               data-server-id="{{ server.serverId }}"
                               data-rpid="{{ server.rpid }}"
                               data-type="repo"
                               style="margin-right: 10px;">
                        <div style="flex: 1; font-weight: bold;">
                          {{ server.repoTitle }}
                          <span style="font-size: 0.85em; color: #666; font-weight: normal;">
                            ({{ server.tools|length }} {{ _('tools') }})
                          </span>
                          {% if server.status == 'connected' %}
                          <span class="badge badge--success" style="margin-left: 5px;">{{ _('Online') }}</span>
                          {% else %}
                          <span class="badge" style="margin-left: 5px;">{{ _('Offline') }}</span>
                          {% endif %}
                        </div>
                        <button type="button" class="button" onclick="toggleServerTools('repo-{{ server.serverId }}')" style="font-size: 0.85em;">
                          <span id="toggle-repo-{{ server.serverId }}">▶</span> {{ _('Expand') }}
                        </button>
                      </label>
                      <div id="repo-{{ server.serverId }}" style="display: none; margin-left: 25px;">
                        {% for tool in server.tools %}
                        <div class="tool-item" style="margin-bottom: 8px; padding: 8px; border: 1px solid #eee; border-radius: 3px; background: #fafafa;">
                          <label style="display: flex; align-items: flex-start; cursor: pointer;">
                            <input type="checkbox" 
                                   name="toolIds" 
                                   value="{{ tool._id.toString() }}" 
                                   class="tool-checkbox"
                                   data-server-id="{{ server.serverId }}"
                                   {% if tool._id.toString() in assignedToolIds %}checked{% endif %}
                                   style="margin-right: 10px; margin-top: 3px;">
                            <div style="flex: 1;">
                              <div style="font-weight: bold; margin-bottom: 3px; font-size: 0.9em;">
                                {{ tool.name }}
                              </div>
                              <div style="font-size: 0.85em; color: #666; margin-bottom: 3px;">
                                {{ tool.description }}
                              </div>
                              {% if tool.inputSchema %}
                              <details style="font-size: 0.8em; color: #888;">
                                <summary style="cursor: pointer;">{{ _('View Parameters') }}</summary>
                                <pre style="margin-top: 5px; padding: 5px; background: #f5f5f5; border-radius: 3px; overflow-x: auto; font-size: 0.75em;">{{ tool.inputSchema|json }}</pre>
                              </details>
                              {% endif %}
                            </div>
                          </label>
                        </div>
                        {% endfor %}
                      </div>
                    </div>
                    {% endfor %}
                  </div>
                </div>
                {% else %}
                <div style="margin-bottom: 20px;">
                  <h3 style="font-size: 1.1em; margin-bottom: 10px;">{{ _('Repo (Repo-Specific Tools)') }}</h3>
                  <p class="note" style="margin-top: 10px;">{{ _('No repo MCP tools available. Select repos above to enable repo tools.') }}</p>
                </div>
                {% endif %}

                <!-- Node MCP Tools -->
                {% if nodeServers and nodeServers.length > 0 %}
                <div style="margin-bottom: 20px;">
                  <h3 style="font-size: 1.1em; margin-bottom: 10px;">{{ _('Node (Node-Provided Tools)') }}</h3>
                  <div style="max-height: 400px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; border-radius: 4px; background: #f9f9f9;">
                    {% for node in nodeServers %}
                    <div class="mcp-node-group" style="margin-bottom: 15px; padding: 10px; border: 1px solid #ddd; border-radius: 4px; background: white;">
                      <label style="display: flex; align-items: center; cursor: pointer; margin-bottom: 10px;">
                        <input type="checkbox" 
                               class="node-select-all" 
                               data-node-id="{{ node.nodeId }}"
                               data-type="node"
                               style="margin-right: 10px;">
                        <div style="flex: 1; font-weight: bold;">
                          {{ node.name }}
                          <span style="font-size: 0.85em; color: #666; font-weight: normal;">
                            ({{ node.tools|length }} {{ _('tools') }})
                          </span>
                        </div>
                        <button type="button" class="button" onclick="toggleNodeTools('node-{{ node.nodeId }}')" style="font-size: 0.85em;">
                          <span id="toggle-node-{{ node.nodeId }}">▶</span> {{ _('Expand') }}
                        </button>
                      </label>
                      <div id="node-{{ node.nodeId }}" style="display: none; margin-left: 25px;">
                        {% for tool in node.tools %}
                        <div class="tool-item" style="margin-bottom: 8px; padding: 8px; border: 1px solid #eee; border-radius: 3px; background: #fafafa;">
                          <label style="display: flex; align-items: flex-start; cursor: pointer;">
                            <input type="checkbox" 
                                   name="toolIds" 
                                   value="{{ tool._id.toString() }}" 
                                   class="tool-checkbox"
                                   data-node-id="{{ node.nodeId }}"
                                   {% if tool._id.toString() in assignedToolIds %}checked{% endif %}
                                   style="margin-right: 10px; margin-top: 3px;">
                            <div style="flex: 1;">
                              <div style="font-weight: bold; margin-bottom: 3px; font-size: 0.9em;">
                                {{ tool.name }}
                              </div>
                              <div style="font-size: 0.85em; color: #666; margin-bottom: 3px;">
                                {{ tool.description }}
                              </div>
                              {% if tool.inputSchema %}
                              <details style="font-size: 0.8em; color: #888;">
                                <summary style="cursor: pointer;">{{ _('View Parameters') }}</summary>
                                <pre style="margin-top: 5px; padding: 5px; background: #f5f5f5; border-radius: 3px; overflow-x: auto; font-size: 0.75em;">{{ tool.inputSchema|json }}</pre>
                              </details>
                              {% endif %}
                            </div>
                          </label>
                        </div>
                        {% endfor %}
                      </div>
                    </div>
                    {% endfor %}
                  </div>
                </div>
                {% else %}
                <div style="margin-bottom: 20px;">
                  <h3 style="font-size: 1.1em; margin-bottom: 10px;">{{ _('Node (Node-Provided Tools)') }}</h3>
                  <p class="note" style="margin-top: 10px;">{{ _('No node MCP tools available.') }}</p>
                </div>
                {% endif %}
              </label>
            </div>
          </div>

          <div class="row">
            <div class="columns">
              <button 
                name="operation" 
                value="{{ 'update' if adoc else 'create' }}" 
                data-default-submit 
                type="submit" 
                class="rounded primary button">
                {{ _('Update') if adoc else _('Create') }} (Ctrl+Enter)
              </button>
              {% if adoc and (handler.user.hasPriv(PRIV.PRIV_EDIT_SYSTEM) or handler.user.own(adoc)) %}
              <button name="operation" value="delete" type="submit" class="rounded button">
                {{ _('Delete') }}
              </button>
              {% endif %}
              <button type="button" class="rounded button" onclick="window.history.go(-1)">
                {{ _('Cancel') }}
              </button>
            </div>
          </div>
        </form>
      </div>
    </div>
  </div>
  <div class="medium-3 columns">
    <div class="section side visiable nojs--hide section--problem-sidebar-tags">
      <div class="section__header">
        <h1 class="section__title">{{ _('Categories') }} ({{ _('click to add') }})</h1>
      </div>
      <div class="section__body problem-sidebar-tags__detail">
        {% include "partials/category.html" %}
      </div>
    </div>
  </div>
</div>

<script>
  // 展开/折叠服务器工具列表
  function toggleServerTools(containerId) {
    const container = document.getElementById(containerId);
    const toggle = document.getElementById('toggle-' + containerId);
    if (container.style.display === 'none') {
      container.style.display = 'block';
      toggle.textContent = '▼';
    } else {
      container.style.display = 'none';
      toggle.textContent = '▶';
    }
  }

  // 展开/折叠 node 工具列表
  function toggleNodeTools(containerId) {
    const container = document.getElementById(containerId);
    const toggle = document.getElementById('toggle-' + containerId);
    if (container.style.display === 'none') {
      container.style.display = 'block';
      toggle.textContent = '▼';
    } else {
      container.style.display = 'none';
      toggle.textContent = '▶';
    }
  }

  // 全选/取消全选服务器下的所有工具
  document.addEventListener('DOMContentLoaded', function() {
    // Provider 服务器全选
    document.querySelectorAll('.server-select-all[data-type="provider"]').forEach(function(checkbox) {
      checkbox.addEventListener('change', function() {
        const serverId = this.getAttribute('data-server-id');
        const toolCheckboxes = document.querySelectorAll('.tool-checkbox[data-server-id="' + serverId + '"]');
        toolCheckboxes.forEach(function(tool) {
          tool.checked = checkbox.checked;
        });
      });
    });

    // Repo 服务器全选
    document.querySelectorAll('.repo-select-all').forEach(function(checkbox) {
      checkbox.addEventListener('change', function() {
        const serverId = this.getAttribute('data-server-id');
        const toolCheckboxes = document.querySelectorAll('.tool-checkbox[data-server-id="' + serverId + '"]');
        toolCheckboxes.forEach(function(tool) {
          tool.checked = checkbox.checked;
        });
      });
    });

    // Node 全选
    document.querySelectorAll('.node-select-all').forEach(function(checkbox) {
      checkbox.addEventListener('change', function() {
        const nodeId = this.getAttribute('data-node-id');
        const toolCheckboxes = document.querySelectorAll('.tool-checkbox[data-node-id="' + nodeId + '"]');
        toolCheckboxes.forEach(function(tool) {
          tool.checked = checkbox.checked;
        });
      });
    });

    // 工具复选框变化时，更新全选复选框状态
    document.querySelectorAll('.tool-checkbox').forEach(function(tool) {
      tool.addEventListener('change', function() {
        const serverId = this.getAttribute('data-server-id');
        const nodeId = this.getAttribute('data-node-id');
        
        if (serverId) {
          const serverCheckbox = document.querySelector('.server-select-all[data-server-id="' + serverId + '"]') ||
                                 document.querySelector('.repo-select-all[data-server-id="' + serverId + '"]');
          if (serverCheckbox) {
            const toolCheckboxes = document.querySelectorAll('.tool-checkbox[data-server-id="' + serverId + '"]');
            const allChecked = Array.from(toolCheckboxes).every(function(cb) { return cb.checked; });
            const someChecked = Array.from(toolCheckboxes).some(function(cb) { return cb.checked; });
            serverCheckbox.checked = allChecked;
            serverCheckbox.indeterminate = someChecked && !allChecked;
          }
        }
        
        if (nodeId) {
          const nodeCheckbox = document.querySelector('.node-select-all[data-node-id="' + nodeId + '"]');
          if (nodeCheckbox) {
            const toolCheckboxes = document.querySelectorAll('.tool-checkbox[data-node-id="' + nodeId + '"]');
            const allChecked = Array.from(toolCheckboxes).every(function(cb) { return cb.checked; });
            const someChecked = Array.from(toolCheckboxes).some(function(cb) { return cb.checked; });
            nodeCheckbox.checked = allChecked;
            nodeCheckbox.indeterminate = someChecked && !allChecked;
          }
        }
      });
    });

    // 初始化全选复选框状态
    document.querySelectorAll('.server-select-all, .repo-select-all, .node-select-all').forEach(function(checkbox) {
      const serverId = checkbox.getAttribute('data-server-id');
      const nodeId = checkbox.getAttribute('data-node-id');
      
      if (serverId) {
        const toolCheckboxes = document.querySelectorAll('.tool-checkbox[data-server-id="' + serverId + '"]');
        const allChecked = Array.from(toolCheckboxes).every(function(cb) { return cb.checked; });
        const someChecked = Array.from(toolCheckboxes).some(function(cb) { return cb.checked; });
        checkbox.checked = allChecked;
        checkbox.indeterminate = someChecked && !allChecked;
      }
      
      if (nodeId) {
        const toolCheckboxes = document.querySelectorAll('.tool-checkbox[data-node-id="' + nodeId + '"]');
        const allChecked = Array.from(toolCheckboxes).every(function(cb) { return cb.checked; });
        const someChecked = Array.from(toolCheckboxes).some(function(cb) { return cb.checked; });
        checkbox.checked = allChecked;
        checkbox.indeterminate = someChecked && !allChecked;
      }
    });
  });
</script>
{% endblock %}
