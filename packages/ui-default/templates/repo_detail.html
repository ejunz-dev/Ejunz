{% extends "layout/basic.html" %}
{% block content %}
<div class="row">
  <div class="medium-9 columns">
    <div class="section">
      <div class="section__header">
        <h1 class="section__title">{{ repo.title }}</h1>
      </div>
      <div class="section__body">
        {% if repo %}
          {% if repo.content %}
            <div class="typo richmedia topic__content" data-emoji-enabled>
              {{ repo.content|markdown|safe }}
            </div>
          {% else %}
            <p style="color: #888;">{{ _("No description available.") }}</p>
          {% endif %}

          <div class="section" style="margin-top: 30px;">
            <div class="section__header">
              <h2>{{ _("Document Structure") }}</h2>
            </div>
            <div class="section__body">
              <div id="doc-tree-container">
                <div id="doc-tree"></div>
                {% if rootDocs|length == 0 %}
                  <p style="color: #888; padding: 20px;">{{ _("No documents yet. Create a document to get started.") }}</p>
                {% endif %}
              </div>
            </div>
          </div>
        {% else %}
          <p>{{ _("Repo not found.") }}</p>
        {% endif %}
      </div>
    </div>
  </div>

  <div class="medium-3 columns">
    <div class="section">
      <div class="section__header">
        <h2 class="section__title">{{ _("Actions") }}</h2>
      </div>
      <div class="section__body">
        {% if repo %}
          <div style="margin-bottom:10px;">
            <div style="font-size:12px;color:#888;margin-bottom:4px;">{{ _('Mode') }}</div>
            <div style="display:flex;gap:4px;">
              <a href="{{ url('repo_mode_switch_branch', domainId=repo.domainId, rpid=repo.rpid, mode='file', branch=currentBranch) }}" 
                 class="button {% if (repo.mode or 'file') == 'file' %}primary{% else %}secondary{% endif %}" 
                 style="flex:1; padding: 6px;">
                {{ _('File') }}
              </a>
              <a href="{{ url('repo_mode_switch_branch', domainId=repo.domainId, rpid=repo.rpid, mode='manuscript', branch=currentBranch) }}" 
                 class="button {% if (repo.mode or 'file') == 'manuscript' %}primary{% else %}secondary{% endif %}" 
                 style="flex:1; padding: 6px;">
                {{ _('Manuscript') }}
              </a>
            </div>
          </div>

          <div style="margin-bottom:10px;">
            <div style="font-size:12px;color:#888;margin-bottom:4px;">{{ _('Branch') }}</div>
            <select id="branch-select" style="width:100%;margin-bottom:6px;" onchange="(function(){
              var sel=document.getElementById('branch-select');
              var b=sel && sel.value ? sel.value : '{{ currentBranch }}';
              var url='{{ url('repo_detail_branch', domainId=repo.domainId, rpid=repo.rpid, branch='__BR__') }}'.replace('__BR__', encodeURIComponent(b));
              window.location.href=url;
            })()">
              {% for b in branches %}
                <option value="{{ b }}" {% if b == currentBranch %}selected{% endif %}>{{ b }}</option>
              {% endfor %}
            </select>

            <button type="button" class="button success expanded" style="margin-bottom:8px;" onclick="(function(){
              var name = window.prompt('{{ _('Enter new branch name') }}');
              if (!name) return;
              var url='{{ url('repo_branch_create_with_param', domainId=repo.domainId, rpid=repo.rpid, branch='__BR__') }}'.replace('__BR__', encodeURIComponent(name));
              window.location.href = url;
            })()">{{ _('Create Branch') }}</button>

            {% if gitStatus %}
              <div class="typo" style="margin-top: 10px; padding: 12px; background-color: #f8f9fa; border: 1px solid #dee2e6; border-radius: 4px; font-size: 12px;">
                <div style="font-weight: 600; margin-bottom: 8px; font-size: 13px;">üìä {{ _('Git Status') }}</div>
                
                {% if gitStatus.hasLocalRepo %}
                  <div style="margin-bottom: 6px;">
                    <span style="color: #28a745;">‚úì</span> {{ _('Local Repository') }}
                    {% if gitStatus.currentBranch %}
                      <span style="color: #888; font-size: 11px;">({{ gitStatus.currentBranch }})</span>
                    {% endif %}
                  </div>
                  
                  {% if gitStatus.hasLocalBranch %}
                    <div style="margin-bottom: 6px;">
                      <span style="color: #28a745;">‚úì</span> {{ _('Local Branch') }}: <strong>{{ currentBranch }}</strong>
                      <span style="color: #888; font-size: 11px;">({{ gitStatus.localCommits }} {{ _('commits') }})</span>
                    </div>
                    
                    {% if gitStatus.uncommittedChanges %}
                      <div style="margin-bottom: 6px; color: #dc3545;">
                        <span>‚ö†</span> {{ _('Uncommitted changes') }}
                      </div>
                    {% endif %}
                    
                    {% if gitStatus.lastCommit %}
                      <div style="margin-bottom: 6px; font-size: 11px; color: #666;">
                        <div style="margin-top: 4px;">
                          <strong>{{ _('Last Commit') }}:</strong> {{ gitStatus.lastCommitShort or gitStatus.lastCommit }}
                        </div>
                        {% if gitStatus.lastCommitMessage %}
                          <div style="margin-top: 2px; color: #888; word-break: break-word; white-space: pre-wrap;">{{ gitStatus.lastCommitMessage }}</div>
                        {% elif gitStatus.lastCommit %}
                          <div style="margin-top: 2px; color: #888; font-style: italic;">{{ _('No commit message') }}</div>
                        {% endif %}
                        {% if gitStatus.lastCommitTime %}
                          <div style="margin-top: 2px; color: #888;">{{ gitStatus.lastCommitTime }}</div>
                        {% endif %}
                      </div>
                    {% endif %}
                  {% else %}
                    <div style="margin-bottom: 6px; color: #ffc107;">
                      <span>‚ö†</span> {{ _('Local branch not found') }}: {{ currentBranch }}
                    </div>
                  {% endif %}
                  
                  {% if gitStatus.hasRemote %}
                    <div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid #dee2e6;">
                      <div style="margin-bottom: 6px;">
                        <span style="color: #28a745;">‚úì</span> {{ _('Remote Repository') }}
                      </div>
                      
                      {% if gitStatus.hasRemoteBranch %}
                        <div style="margin-bottom: 6px;">
                          <span style="color: #28a745;">‚úì</span> {{ _('Remote Branch') }}: <strong>{{ currentBranch }}</strong>
                          <span style="color: #888; font-size: 11px;">({{ gitStatus.remoteCommits }} {{ _('commits') }})</span>
                        </div>
                        
                        {% if gitStatus.behind > 0 %}
                          <div style="margin-bottom: 6px; color: #ffc107;">
                            <span>‚¨á</span> {{ _('Behind remote by {0} commit(s)').format(gitStatus.behind) }}
                          </div>
                        {% endif %}
                        
                        {% if gitStatus.ahead > 0 %}
                          <div style="margin-bottom: 6px; color: #17a2b8;">
                            <span>‚¨Ü</span> {{ _('Ahead of remote by {0} commit(s)').format(gitStatus.ahead) }}
                          </div>
                        {% endif %}
                        
                        {% if gitStatus.behind == 0 and gitStatus.ahead == 0 and gitStatus.hasRemoteBranch %}
                          <div style="margin-bottom: 6px; color: #28a745;">
                            <span>‚úì</span> {{ _('Up to date with remote') }}
                          </div>
                        {% endif %}
                      {% else %}
                        <div style="margin-bottom: 6px; color: #ffc107;">
                          <span>‚ö†</span> {{ _('Remote branch not found') }}: {{ currentBranch }}
                        </div>
                      {% endif %}
                    </div>
                  {% else %}
                    <div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid #dee2e6; color: #888;">
                      <span>‚Äî</span> {{ _('No remote repository configured') }}
                    </div>
                  {% endif %}
                {% else %}
                  <div style="color: #888;">
                    <span>‚Äî</span> {{ _('No local git repository') }}
                  </div>
                {% endif %}
              </div>
            {% elif branchStatus and branchStatus.hasRemote %}
              <div class="typo" style="margin-top: 10px; padding: 10px; background-color: #fff3cd; border: 1px solid #ffc107; border-radius: 4px; font-size: 13px;">
                <div style="font-weight: 600; margin-bottom: 4px;">‚ö†Ô∏è {{ _('Remote Branch Status') }}</div>
                <div style="color: #856404;">
                  {% if branchStatus.behind > 0 %}
                    {{ _('This branch is behind remote by {0} commit(s). Please use Pull to sync.', branchStatus.behind) }}
                  {% else %}
                    {{ _('Remote branch exists. Use Pull to sync with remote changes.') }}
                  {% endif %}
                </div>
              </div>
            {% endif %}
          </div>

          <a href="{{ url('repo_edit', domainId=repo.domainId, rpid=repo.rpid) }}" class="button primary expanded" style="margin-bottom: 8px;">
            {{ _('Edit Repo info') }}
          </a>

          {% if gitStatus %}
            {% if gitStatus.ahead > 0 %}
              <form id="push-form" method="post" action="{{ url('repo_github_push_branch', domainId=repo.domainId, rpid=repo.rpid, branch=currentBranch) }}">
                <button type="submit" class="button warning expanded" style="margin-bottom: 8px;">{{ _('Push to GitHub') }}</button>
              </form>
            {% elif gitStatus.behind > 0 %}
              <form id="pull-form" method="post" action="{{ url('repo_github_pull_branch', domainId=repo.domainId, rpid=repo.rpid, branch=currentBranch) }}">
                <button type="submit" class="button alert expanded">{{ _('Pull from GitHub') }}</button>
              </form>
            {% endif %}
          {% else %}
            {# Â¶ÇÊûúÊ≤°Êúâ gitStatusÔºåÊòæÁ§∫‰∏§‰∏™ÊåâÈíÆ‰Ωú‰∏∫ÂêéÂ§á #}
            <button type="button" class="button warning expanded" style="margin-bottom: 8px;" onclick="(function(){
              var note = window.prompt('{{ _('Enter commit message (optional)') }}', '');
              if (note === null) return;
              var form = document.createElement('form');
              form.method='post';
              form.action='{{ url('repo_github_push_branch', domainId=repo.domainId, rpid=repo.rpid, branch=currentBranch) }}';
              var input=document.createElement('input'); input.type='hidden'; input.name='note'; input.value=note || ''; form.appendChild(input);
              document.body.appendChild(form); form.submit();
            })()">{{ _('Push to GitHub') }}</button>

            <form method="post" action="{{ url('repo_github_pull_branch', domainId=repo.domainId, rpid=repo.rpid, branch=currentBranch) }}">
              <button type="submit" class="button alert expanded">{{ _('Pull from GitHub') }}</button>
            </form>
          {% endif %}
        {% endif %}
      </div>
    </div>
  </div>
</div>
{% endblock %}
