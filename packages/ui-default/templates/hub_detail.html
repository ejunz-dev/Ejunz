{% extends "layout/basic.html" %}
{% import "components/comments_file.html" as comments with context %}
{% block content %}
<div class="row">
  <div class="medium-9 columns">
    <div class="section">
      <div class="section__body">
        <ul class="supplementary list">
          <li>
            <a class="discussion-node-tag" href="{{ url('hub_node', type=model.hub.typeDisplay[vnode.type], name=vnode.id) }}">
            {% if ddoc.parentType == model.document.TYPE_HUB_NODE %}
              <span class="v-center icon icon-tag"></span>
              {{ _('Hub:') }}
            {% elif ddoc.parentType == model.document.TYPE_HUB_NODE %}
              <span class="v-center icon icon-tag"></span>
              {{ _('Hub:') }}
            {% elif ddoc.parentType == model.document.TYPE_CONTEST %}
              <span class="v-center icon icon-award"></span>
              {{ _('Contest:') }}
            {% elif ddoc.parentType == model.document.TYPE_DOCS %}
              <span class="v-center icon icon-book"></span>
              {{ _('Docs:') }}
            {% elif ddoc.parentType == model.document.TYPE_PROBLEM %}
              <span class="v-center icon icon-flag"></span>
              {{ _('Problem:') }}
            {% else %}
              <span class="v-center icon icon-flag"></span>
              {{ _('Unknown Node') }}
            {% endif %}
              {{ vnode.title|default('Untitled Node') }}
            </a>
          </li>
          <li><h2>{{ ddoc.title }}</h2></li>
          <li>
            {{ user.render_inline(udict[ddoc.owner]) }}
            @
            {{ datetimeSpan(ddoc._id)|safe }}
          </li>
        </ul>
        <div class="typo topic__content richmedia" data-emoji-enabled data-raw-url="{{ url('hub_raw', did=ddoc.docId) }}">
          {{ ddoc.content|markdown|safe }}
        </div>
      </div>
      <ul class="section__footer supplementary dot list">
      {% if handler.user.hasPerm(perm.PERM_EDIT_HUB) or (handler.user.own(ddoc) and handler.user.hasPerm(perm.PERM_EDIT_HUB_SELF)) %}
        <li><a href="{{ url('hub_edit', did=ddoc.docId) }}">
          <span class="icon icon-edit"></span> {{ _('Edit') }}
        </a></li>
      {% endif %}
      {% if ddoc.edited %}
        <li data-hub-history data-raw-url="{{ url('hub_raw', did=ddoc.docId) }}">{{ _('Edited') }}</li>
      {% endif %}
        <li>{{ _('{0} views').format(ddoc.views) }}</li>
      {% if handler.user.hasPriv(PRIV.PRIV_USER_PROFILE) %}
        <li><form class="form--inline" method="post">
          <input type="hidden" name="operation" value="{% if not dsdoc['star'] %}star{% else %}unstar{% endif %}">
          <button class="star{% if dsdoc['star'] %} activated{% endif %}" type="submit">
            <span class="starred--hide"><span class="icon icon-star--outline"></span> {{ _('Star Topic') }}</span>
            <span class="starred--show"><span class="icon icon-star"></span> {{ _('Unstar Topic') }}</span>
          </button>
        </form></li>
      {% endif %}
      {% if handler.user.own(ddoc) or handler.user.hasPerm(perm.PERM_LOCK_HUB) %}
        <li><form class="form--inline" method="post">
          <input type="hidden" name="operation" value="set_lock">
          {% if not ddoc.lock %}<input type="hidden" name="lock" value="1">{% endif %}
          <button class="star{% if ddoc.lock %} activated{% endif %}" type="submit">
            <span class="starred--hide">{{ _('Lock Topic') }}</span>
            <span class="starred--show">{{ _('Unlock Topic') }}</span>
          </button>
        </form></li>
      {% endif %}
        <li><a href="{{ url('wiki_help', anchor='contact') }}">
          <span class="icon icon-warning"></span> {{ _('Report') }}
        </a></li>
      {% if handler.user.hasPerm(perm.PERM_ADD_REACTION) %}
        <li><a href="javascript:;" data-op="react" data-type="hub" data-form="{{ {operation: 'reaction', nodeType:'did', id: ddoc._id }|json }}">
          <span class="icon icon-emoji"></span>
        </a></li>
      {% endif %}
      <div class="reactions list" data-type="did" data-did="{{ ddoc._id }}">
        {% for e in Object.entries(ddoc.react or {})|sort(true, false, 1)|selectattr(1) %}
          <div class="reaction{% if reactions[ddoc.docId][e[0]] %} active{% endif %}"><span class="emoji">{{ e[0] }}</span> {{ e[1] }}</div>
        {% endfor %}
      </div>
      </ul>
    </div>
    <div class="section">
      <div class="section__header">
        <h1 class="section__title">{{ _('{0} comments').format(drcount) }}</h1>
      </div>
      <div class="section__body">
        {{ comments.render(
          view = 'hub',
          docs = drdocs,
          udict = udict,
          comment_ref = 'drid',
          reply_ref = 'drrid',
          comment_post_op = 'reply',
          reply_post_op = 'tail_reply',
          comment_edit_op = 'edit_reply',
          comment_delete_op = 'delete_reply',
          reply_edit_op = 'edit_tail_reply',
          reply_delete_op = 'delete_tail_reply',
          comment_post_perm = perm.PERM_REPLY_HUB,
          comment_delete_perm = perm.PERM_DELETE_HUB_REPLY_SELF_HUB if handler.user.own(ddoc) else perm.PERM_DELETE_HUB_REPLY,
          comment_edit_self_perm = perm.PERM_EDIT_HUB_REPLY_SELF,
          comment_delete_self_perm = perm.PERM_DELETE_HUB_REPLY_SELF_HUB if handler.user.own(ddoc) else perm.PERM_DELETE_HUB_REPLY,
          reply_post_perm = perm.PERM_REPLY_HUB,
          reply_delete_perm = perm.PERM_DELETE_HUB_REPLY,
          reply_edit_self_perm = perm.PERM_EDIT_HUB_REPLY_SELF,
          reply_delete_self_perm = perm.PERM_DELETE_HUB_REPLY_SELF,
          reactions = reactions,
          ddoc = ddoc
        ) }}
        {{ paginator.render(page, pcount) }}
      {% if drcount == 0 %}
        {{ nothing.render('No comments so far...') }}
      {% endif %}
      </div>
    </div>
  </div>
  <div class="medium-3 columns">
    {% set udoc = udict[ddoc.owner] %}
    <div class="section side">
      <div class="profile__bg user-profile-bg--1"></div>
      <div class="section__body">
        <div class="media sidebar-user-profile">
          <div class="media__left">
            <img src="{{ avatarUrl(udoc.avatar, 80) }}" width="80" height="80" class="medium user-profile-avatar">
          </div>
          <div class="media__body">
            <p>{{ user.render_inline(udoc, avatar=false, modbadge=false) }}</p>
          </div>
        </div>
      </div>
      <div class="section__body">
        <div class="balancer sidebar-user-stat">
          <div class="balancer__body">
            <div class="numbox">
              <div class="numbox__num medium">{{ udoc.nAccept|default(0) }}</div>
              <div class="numbox__text">{{ _('Accepted') }}</div>
            </div>
          </div>
          <div class="balancer__body">
            <div class="numbox">
              <div class="numbox__num medium">{{ udoc.nLike|default(0) }}</div>
              <div class="numbox__text">{{ _('Solutions Liked') }}</div>
            </div>
          </div>
        </div>
      </div>
    </div>
    {% if vnode.type == model.document.TYPE_PROBLEM %}
      {% set pdoc = vnode %}
      {% set owner_udoc = udict[vnode.owner] %}
      {% include "partials/problem_sidebar.html" %}
    {% endif %}
  </div>
  <div class="medium-3 columns">
    <div class="section">
      <h3>D3.js 测试</h3>
      <svg id="d3-test" width="200" height="200"></svg>
    </div>
  </div>
</div>

</div>
<script src="https://d3js.org/d3.v7.min.js"></script>
<script>
document.addEventListener("DOMContentLoaded", function () {
  const width = 200;
  const height = 200;

  // 选择已有的 <svg> 并清空
  const svg = d3.select("#d3-test")
      .attr("viewBox", [-width / 2, -height / 2, width, height])
      .attr("width", width)
      .attr("height", height)
      .attr("style", "max-width: 100%; height: auto;");

  const simulation = d3.forceSimulation()
      .force("charge", d3.forceManyBody().strength(-30)) 
      .force("link", d3.forceLink().id(d => d.id).distance(50)) 
      .force("x", d3.forceX())
      .force("y", d3.forceY())
      .on("tick", ticked);

  let link = svg.append("g")
      .attr("stroke", "#999")
      .attr("stroke-opacity", 0.6)
    .selectAll("line");

  let node = svg.append("g")
      .attr("stroke", "#fff")
      .attr("stroke-width", 1.5)
    .selectAll("circle");

  function ticked() {
    node.attr("cx", d => d.x)
        .attr("cy", d => d.y);

    link.attr("x1", d => d.source.x)
        .attr("y1", d => d.source.y)
        .attr("x2", d => d.target.x)
        .attr("y2", d => d.target.y);
  }
function drag(simulation) {
  return d3.drag()
    .on("start", (event, d) => {
      if (!event.active) simulation.alphaTarget(0.3).restart();
      d.fx = d.x;
      d.fy = d.y;
    })
    .on("drag", (event, d) => {
      d.fx = event.x;
      d.fy = event.y;
    })
    .on("end", (event, d) => {
      if (!event.active) simulation.alphaTarget(0);
      d.fx = null;
      d.fy = null;
    });
}

  function update({nodes, links}) {
    const old = new Map(node.data().map(d => [d.id, d]));
    nodes = nodes.map(d => ({...old.get(d.id), ...d}));
    links = links.map(d => ({...d}));

    node = node
      .data(nodes, d => d.id)
      .join(enter => enter.append("circle")
        .attr("r", 5)
        .attr("fill", "steelblue")
        .call(drag(simulation))
        .call(node => node.append("title").text(d => d.id)));

    link = link
      .data(links, d => [d.source, d.target])
      .join("line");

    simulation.nodes(nodes);
    simulation.force("link").links(links);
    simulation.alpha(1).restart();
  }

  const testData = {
    nodes: [
      { id: "A" },
      { id: "B" },
      { id: "C" }
    ],
    links: [
      { source: "A", target: "B" },
      { source: "B", target: "C" }
    ]
  };
  

  update(testData);
});

</script>
{% endblock %}
