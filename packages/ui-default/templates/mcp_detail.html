{% set page_name = "mcp_detail" %}
{% extends "layout/basic.html" %}
{% block content %}
<div class="row">
    <div class="medium-9 columns">
        <div class="section">
            <div class="section__header">
                <h1 class="section__title">{{ server.name }}</h1>
                <div class="section__action">
                    <span class="server-status server-status-{{ server.status }}">
                        {% if server.status == 'connected' %}
                            已连接
                        {% elif server.status == 'disconnected' %}
                            已断开
                        {% elif server.status == 'error' %}
                            错误
                        {% else %}
                            {{ server.status }}
                        {% endif %}
                    </span>
                </div>
            </div>
            <div class="section__body">
                {% if server.description %}
                    <p>{{ server.description }}</p>
                {% endif %}
                
                <div class="server-info">
                    <h3>服务器信息</h3>
                    <table class="data-table">
                        <tr>
                            <th>服务器 ID</th>
                            <td>{{ server.serverId }}</td>
                        </tr>
                        <tr>
                            <th>状态</th>
                            <td>
                                <span class="server-status server-status-{{ server.status }}">
                                    {% if server.status == 'connected' %}
                                        已连接
                                    {% elif server.status == 'disconnected' %}
                                        已断开
                                    {% elif server.status == 'error' %}
                                        错误
                                    {% else %}
                                        {{ server.status }}
                                    {% endif %}
                                </span>
                            </td>
                        </tr>
                        <tr>
                            <th>工具数量</th>
                            <td>{{ server.toolsCount|default(0) }}</td>
                        </tr>
                        <tr>
                            <th>最后连接时间</th>
                            <td>
                                {% if server.lastConnectedAt %}
                                    {{ datetimeSpan(server.lastConnectedAt)|safe }}
                                {% else %}
                                    -
                                {% endif %}
                            </td>
                        </tr>
                        <tr>
                            <th>最后断开时间</th>
                            <td>
                                {% if server.lastDisconnectedAt %}
                                    {{ datetimeSpan(server.lastDisconnectedAt)|safe }}
                                {% else %}
                                    -
                                {% endif %}
                            </td>
                        </tr>
                        {% if server.errorMessage %}
                            <tr>
                                <th>错误信息</th>
                                <td class="text-danger">{{ server.errorMessage }}</td>
                            </tr>
                        {% endif %}
                        <tr>
                            <th>创建时间</th>
                            <td>
                                {% if server.createdAt %}
                                    {{ datetimeSpan(server.createdAt)|safe }}
                                {% else %}
                                    -
                                {% endif %}
                            </td>
                        </tr>
                    </table>
                </div>

                <div class="tools-section">
                    <div class="tools-section-header">
                        <h3>工具列表</h3>
                        {% if handler.user.hasPriv(model.builtin.PRIV.PRIV_USER_PROFILE) %}
                            <button class="button small mcp-refresh-tools-btn" data-server-id="{{ server.serverId }}" data-domain-id="{{ domainId }}">
                                刷新工具列表
                            </button>
                        {% endif %}
                    </div>
                    {% if tools and tools.length > 0 %}
                        <div class="tools-list">
                            {% for tool in tools %}
                                <div class="tool-card">
                                    <div class="tool-header">
                                        <h4 class="tool-name">{{ tool.name }}</h4>
                                        <span class="tool-id">ID: {{ tool.toolId }}</span>
                                    </div>
                                    <div class="tool-description">
                                        <p>{{ tool.description }}</p>
                                    </div>
                                    {% if tool.inputSchema %}
                                        <div class="tool-schema">
                                            <strong>输入模式：</strong>
                                            <pre><code>{{ tool.inputSchema|json|safe }}</code></pre>
                                        </div>
                                    {% endif %}
                                </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <p class="text-gray">暂无工具。服务器连接后会自动同步工具列表。</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    <div class="medium-3 columns">
        <div class="section">
            <div class="section__header">
                <h1 class="section__title">操作</h1>
            </div>
            <div class="section__body">
                <a href="{{ url('mcp_domain', { domainId: domainId }) }}" class="button block">返回列表</a>
                {% if handler.user.hasPriv(model.builtin.PRIV.PRIV_USER_PROFILE) %}
                    <div class="mcp-token-section">
                        <h4>WebSocket Token 管理</h4>
                        {% if server.wsToken %}
                            <div class="token-info">
                                <p><strong>Token:</strong> <code id="ws-token">{{ server.wsToken }}</code></p>
                                {% if wsEndpoint %}
                                    <p><strong>连接 URL:</strong></p>
                                    <div class="endpoint-url">
                                        <code id="ws-endpoint">{{ wsEndpoint }}</code>
                                        <button class="button small mcp-copy-endpoint-btn">复制</button>
                                    </div>
                                {% endif %}
                                <button class="button block danger mcp-delete-token-btn" data-server-id="{{ server.serverId }}">删除 Token</button>
                            </div>
                        {% else %}
                            <p>尚未生成 Token</p>
                            <button class="button block primary mcp-generate-token-btn" data-server-id="{{ server.serverId }}" data-domain-id="{{ domainId }}">生成 Token</button>
                        {% endif %}
                    </div>
                    <form method="post" action="{{ url('mcp_delete', { domainId: domainId }) }}" class="mcp-delete-form">
                        <input type="hidden" name="serverId" value="{{ server.serverId }}">
                        <button type="submit" class="button block danger mcp-delete-server-btn">删除服务器</button>
                    </form>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<div id="mcp-status-ws" 
    data-server-id="{{ server.serverId }}"
    data-domain-id="{{ domainId }}"
    class="mcp-status-ws">
</div>
{% endblock %}

