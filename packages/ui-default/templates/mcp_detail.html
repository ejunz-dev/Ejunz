{% set page_name = "mcp_detail" %}
{% extends "layout/basic.html" %}
{% block content %}
<div class="row">
    <div class="medium-9 columns">
        <div class="section">
            <div class="section__header">
                <h1 class="section__title">{{ server.name }}</h1>
                <div class="section__action">
                    <span class="server-status server-status-{{ server.status }}">
                        {% if server.status == 'connected' %}
                            {{ _('Connected') }}
                        {% elif server.status == 'disconnected' %}
                            {{ _('Disconnected') }}
                        {% elif server.status == 'error' %}
                            {{ _('Error') }}
                        {% else %}
                            {{ server.status }}
                        {% endif %}
                    </span>
                </div>
            </div>
            <div class="section__body">
                {% if server.description %}
                    <p>{{ server.description }}</p>
                {% endif %}
                
                <div class="server-info">
                    <h3>{{ _('Server Information') }}</h3>
                    <table class="data-table">
                        <tr>
                            <th>{{ _('Server ID') }}</th>
                            <td>{{ server.serverId }}</td>
                        </tr>
                        <tr>
                            <th>{{ _('Type') }}</th>
                            <td>
                                {% set serverType = server.type|default('provider') %}
                                {% if serverType == 'repo' %}
                                    <span class="badge badge--primary">Repo</span>
                                {% elif serverType == 'node' %}
                                    <span class="badge badge--info">Node</span>
                                {% else %}
                                    <span class="badge">Provider</span>
                                {% endif %}
                            </td>
                        </tr>
                        <tr>
                            <th>{{ _('Status') }}</th>
                            <td>
                                <span class="server-status server-status-{{ server.status }}">
                                    {% if server.status == 'connected' %}
                                        {{ _('Connected') }}
                                    {% elif server.status == 'disconnected' %}
                                        {{ _('Disconnected') }}
                                    {% elif server.status == 'error' %}
                                        {{ _('Error') }}
                                    {% else %}
                                        {{ server.status }}
                                    {% endif %}
                                </span>
                            </td>
                        </tr>
                        <tr>
                            <th>{{ _('Tools Count') }}</th>
                            <td>{{ server.toolsCount|default(0) }}</td>
                        </tr>
                        <tr>
                            <th>{{ _('Last Connected Time') }}</th>
                            <td>
                                {% if server.lastConnectedAt %}
                                    {{ datetimeSpan(server.lastConnectedAt)|safe }}
                                {% else %}
                                    -
                                {% endif %}
                            </td>
                        </tr>
                        <tr>
                            <th>{{ _('Last Disconnected Time') }}</th>
                            <td>
                                {% if server.lastDisconnectedAt %}
                                    {{ datetimeSpan(server.lastDisconnectedAt)|safe }}
                                {% else %}
                                    -
                                {% endif %}
                            </td>
                        </tr>
                        {% if server.errorMessage %}
                            <tr>
                                <th>{{ _('Error Message') }}</th>
                                <td class="text-danger">{{ server.errorMessage }}</td>
                            </tr>
                        {% endif %}
                        <tr>
                            <th>{{ _('Created Time') }}</th>
                            <td>
                                {% if server.createdAt %}
                                    {{ datetimeSpan(server.createdAt)|safe }}
                                {% else %}
                                    -
                                {% endif %}
                            </td>
                        </tr>
                    </table>
                </div>

                <div class="tools-section">
                    <div class="tools-section-header">
                        <h3>{{ _('Tools List') }}</h3>
                        {% if handler.user.hasPriv(model.builtin.PRIV.PRIV_USER_PROFILE) %}
                            <button class="button small mcp-refresh-tools-btn" data-server-id="{{ server.serverId }}" data-domain-id="{{ domainId }}">
                                {{ _('Refresh Tools List') }}
                            </button>
                        {% endif %}
                    </div>
                    {% if tools and tools.length > 0 %}
                        <div class="tools-list">
                            {% for tool in tools %}
                                <div class="tool-card">
                                    <div class="tool-header">
                                        <h4 class="tool-name">{{ tool.name }}</h4>
                                        <span class="tool-id">ID: {{ tool.toolId }}</span>
                                    </div>
                                    <div class="tool-description">
                                        <p>{{ tool.description }}</p>
                                    </div>
                                    {% if tool.inputSchema %}
                                        <div class="tool-schema">
                                            <strong>{{ _('Input Schema') }}:</strong>
                                            <pre><code>{{ tool.inputSchema|json|safe }}</code></pre>
                                        </div>
                                    {% endif %}
                                </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <p class="text-gray">{{ _('No tools yet. Tools list will be automatically synced after server connection.') }}</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    <div class="medium-3 columns">
        <div class="section">
            <div class="section__header">
                <h1 class="section__title">{{ _('Actions') }}</h1>
            </div>
            <div class="section__body">
                <a href="{{ url('mcp_domain', { domainId: domainId }) }}" class="button block">{{ _('Back to List') }}</a>
                {% if handler.user.hasPriv(model.builtin.PRIV.PRIV_USER_PROFILE) %}
                    <div class="mcp-token-section">
                        <h4>{{ _('WebSocket Token Management') }}</h4>
                        {% if server.wsToken %}
                            <div class="token-info">
                                <p><strong>{{ _('Token') }}:</strong> <code id="ws-token">{{ server.wsToken }}</code></p>
                                {% if wsEndpoint %}
                                    <p><strong>{{ _('Connection URL') }}:</strong></p>
                                    <div class="endpoint-url">
                                        <code id="ws-endpoint">{{ wsEndpoint }}</code>
                                        <button class="button small mcp-copy-endpoint-btn">{{ _('Copy') }}</button>
                                    </div>
                                {% endif %}
                                <button class="button block danger mcp-delete-token-btn" data-server-id="{{ server.serverId }}">{{ _('Delete Token') }}</button>
                            </div>
                        {% else %}
                            <p>{{ _('Token not generated yet') }}</p>
                            <p class="text-gray" style="font-size: 0.9em;">{{ _('Please generate token on') }} <a href="{{ url('edge_main', { domainId: domainId }) }}">{{ _('Edge page') }}</a></p>
                        {% endif %}
                    </div>
                    <form method="post" action="{{ url('mcp_delete', { domainId: domainId }) }}" class="mcp-delete-form">
                        <input type="hidden" name="serverId" value="{{ server.serverId }}">
                        <button type="submit" class="button block danger mcp-delete-server-btn">{{ _('Delete Server') }}</button>
                    </form>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<div id="mcp-status-ws" 
    data-server-id="{{ server.serverId }}"
    data-domain-id="{{ domainId }}"
    class="mcp-status-ws">
</div>
{% endblock %}

