{% import "components/form.html" as form with context %}
{% extends "layout/basic.html" %}
{% block content %}
<div class="row">
  <div class="medium-9 columns">
    <div class="section">
      <div class="section__header">
        <h2 class="section__title">
          {% if block %}
            {{ _("Edit Block") }}
          {% else %}
            {{ _("Create Block") }}
          {% endif %}
        </h2>
      </div>
      <div class="section__body">
        <form method="post">
          <input type="hidden" name="did" value="{{ did if did else block.did }}">
          <input type="hidden" name="rpid" value="{{ rpid if rpid else block.rpid }}">
          {% if block %}
          <input type="hidden" name="bid" value="{{ block.bid }}">
          <input type="hidden" name="branch" value="{{ currentBranch or (block.branch or 'main') }}">
          {% endif %}

          {{ form.form_text({
              columns:12,
              label:_('Block Title'),
              name:'title',
              placeholder:_('Enter block title'),
              value:block.title if block else '',
              autofocus:true
          }) }}

          {{ form.form_textarea({
              columns:12,
              label:_('Block Content'),
              name:'content',
              value:block.content if block else '',
              markdown:true
          }) }}

          {% if block %}
            <div class="row">
              <div class="columns">
                <label>{{ _('Commit Message') }}</label>
                <div style="margin-bottom: 4px; font-size: 12px; color: #888;">
                  {{ _('Default message') }}: <code>{{ handler.context.domainId }}/{{ handler.user._id }}/{{ handler.user.uname or 'unknown' }}</code>
                </div>
                <input type="text" name="commitMessage" id="commit-message-input" placeholder="{{ _('Enter custom message (optional)') }}" value="" style="width: 100%;" oninput="updateCommitPreview()">
                <div style="margin-top: 4px; font-size: 11px; color: #666;">
                  {{ _('Final message will be') }}: <code id="final-message-preview">{{ handler.context.domainId }}/{{ handler.user._id }}/{{ handler.user.uname or 'unknown' }}</code>
                </div>
                <script>
                  function updateCommitPreview() {
                    const input = document.getElementById('commit-message-input');
                    const preview = document.getElementById('final-message-preview');
                    const defaultPrefix = '{{ handler.context.domainId }}/{{ handler.user._id }}/{{ handler.user.uname or "unknown" }}';
                    const customMsg = input.value.trim();
                    preview.textContent = customMsg ? `${defaultPrefix}: ${customMsg}` : defaultPrefix;
                  }
                </script>
              </div>
            </div>
          {% endif %}

          <div class="row">
            <div class="columns">
              <button name="operation" value="{% if block %}update{% else %}create{% endif %}" type="submit" class="rounded primary button">
                {% if block %}
                  {{ _('Update') }}
                {% else %}
                  {{ _('Create') }}
                {% endif %}
              </button>
              {% if block and (handler.user.own(block) or handler.user.hasPriv(PRIV.PRIV_EDIT_SYSTEM)) %}
                <button name="operation" value="delete" type="submit" class="rounded button">
                  {{ _('Delete') }}
                </button>
              {% endif %}
              <button type="button" class="rounded button" onclick="window.history.go(-1)">
                {{ _('Cancel') }}
              </button>
            </div>
          </div>
        </form>
      </div>
    </div>
  </div>

  <div class="medium-3 columns">
    {% include 'components/md_hint.html' %}
  </div>
</div>
{% endblock %}

