{% extends "layout/basic.html" %}
{% block content %}
<script>
  {{ set(UiContext, 'currentBranch', currentBranch) }}
  {{ set(UiContext, 'base', {
    domainId: base.domainId,
    docId: base.docId,
    bid: base.bid,
    currentBranch: currentBranch
  }) }}
  {{ set(UiContext, 'nodeCardsMap', nodeCardsMap or {}) }}
  {{ set(UiContext, 'files', files or []) }}
  // Helper function to get Notification
  async function getNotification() {
    if (window.Ejunz?.components?.Notification) {
      return window.Ejunz.components.Notification;
    }
    try {
      const module = await import('vj/components/notification');
      return module.default;
    } catch (e) {
      // Fallback to alert if Notification is not available
      return {
        success: (msg) => { alert(msg); return Promise.resolve(); },
        error: (msg) => { alert(msg); return Promise.resolve(); },
        info: (msg) => { alert(msg); return Promise.resolve(); }
      };
    }
  }
</script>
<div class="row">
  <div class="large-9 columns">
    <div class="section">
      <div class="section__header">
        <h1 class="section__title">{{ base.title if base else 'ÊÄùÁª¥ÂØºÂõæ' }}</h1>
      </div>
      <div class="section__body no-padding">
        <div id="base-editor" data-doc-id="{{ base.docId if base else '' }}"></div>
      </div>
    </div>
  </div>
  
  <div class="large-3 columns">
    <div class="section">
      <div class="section__header">
        <h1 class="section__title">{{ _('Info') }}</h1>
      </div>
      <div class="section__body">
        {% if branches %}
          <div style="margin-bottom: 10px;">
            <div style="font-size: 12px; color: #888; margin-bottom: 4px;">{{ _('Branch') }}</div>
            <select id="branch-select" style="width: 100%; margin-bottom: 6px;" onchange="(function(){
              var sel = document.getElementById('branch-select');
              var b = sel && sel.value ? sel.value : '{{ currentBranch }}';
              var url = '{{ url('base_detail_branch', domainId=base.domainId, docId=base.docId, branch='__BR__') }}'.replace('__BR__', encodeURIComponent(b));
              window.location.href = url;
            })()">
              {% for b in branches %}
                <option value="{{ b }}" {% if b == currentBranch %}selected{% endif %}>{{ b }}</option>
              {% endfor %}
            </select>

            {% if currentBranch == 'main' %}
            <button type="button" class="button success expanded" style="margin-bottom: 8px;" onclick="(function(){
              var name = window.prompt('{{ _('Enter new branch name') }}');
              if (!name) return;
              var url = '{{ url('base_branch_create_with_param', domainId=base.domainId, docId=base.docId, branch='__BR__') }}'.replace('__BR__', encodeURIComponent(name));
              window.location.href = url;
            })()">{{ _('Create Branch') }}</button>
            {% endif %}
          </div>
        {% endif %}
        
        {% if gitStatus %}
          <div class="typo" style="margin-top: 10px; padding: 12px; background-color: #f8f9fa; border: 1px solid #dee2e6; border-radius: 4px; font-size: 12px;">
            <div style="font-weight: 600; margin-bottom: 8px; font-size: 13px;">üìä {{ _('Git Status') }}</div>
            
            {% if gitStatus.hasLocalRepo %}
              <div style="margin-bottom: 6px;">
                <span style="color: #28a745;">‚úì</span> {{ _('Local Repository') }}
                {% if gitStatus.currentBranch %}
                  <span style="color: #888; font-size: 11px;">({{ gitStatus.currentBranch }})</span>
                {% endif %}
              </div>
              
              {% if gitStatus.hasLocalBranch %}
                <div style="margin-bottom: 6px;">
                  <span style="color: #28a745;">‚úì</span> {{ _('Local Branch') }}: <strong>{{ currentBranch }}</strong>
                  <span style="color: #888; font-size: 11px;">({{ gitStatus.localCommits }} {{ _('commits') }})</span>
                </div>
                
                {% if gitStatus.uncommittedChanges %}
                  <div style="margin-bottom: 6px; color: #dc3545;">
                    <span>‚ö†</span> {{ _('Uncommitted changes') }}
                  </div>
                {% endif %}
                
                {% if gitStatus.lastCommit %}
                  <div style="margin-bottom: 6px; font-size: 11px; color: #666;">
                    <div style="margin-top: 4px;">
                      <strong>{{ _('Last Commit') }}:</strong> {{ gitStatus.lastCommitShort or gitStatus.lastCommit }}
                    </div>
                    {% if gitStatus.lastCommitMessage %}
                      <div style="margin-top: 2px; color: #888; word-break: break-word; white-space: pre-wrap;">{{ gitStatus.lastCommitMessage }}</div>
                    {% elif gitStatus.lastCommit %}
                      <div style="margin-top: 2px; color: #888; font-style: italic;">{{ _('No commit message') }}</div>
                    {% endif %}
                    {% if gitStatus.lastCommitTime %}
                      <div style="margin-top: 2px; color: #888;">{{ gitStatus.lastCommitTime }}</div>
                    {% endif %}
                  </div>
                {% endif %}
              {% else %}
                <div style="margin-bottom: 6px; color: #ffc107;">
                  <span>‚ö†</span> {{ _('Local branch not found') }}: {{ currentBranch }}
                </div>
              {% endif %}
              
              {% if gitStatus.hasRemote %}
                <div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid #dee2e6;">
                  <div style="margin-bottom: 6px;">
                    <span style="color: #28a745;">‚úì</span> {{ _('Remote Repository') }}
                  </div>
                  
                  {% if gitStatus.hasRemoteBranch %}
                    <div style="margin-bottom: 6px;">
                      <span style="color: #28a745;">‚úì</span> {{ _('Remote Branch') }}: <strong>{{ currentBranch }}</strong>
                      <span style="color: #888; font-size: 11px;">({{ gitStatus.remoteCommits }} {{ _('commits') }})</span>
                    </div>
                    
                    {% if gitStatus.behind > 0 %}
                      <div style="margin-bottom: 6px; color: #ffc107;">
                        <span>‚¨á</span> {{ _('Behind remote by {0} commit(s)').format(gitStatus.behind) }}
                      </div>
                    {% endif %}
                    
                    {% if gitStatus.ahead > 0 %}
                      <div style="margin-bottom: 6px; color: #17a2b8;">
                        <span>‚¨Ü</span> {{ _('Ahead of remote by {0} commit(s)').format(gitStatus.ahead) }}
                      </div>
                    {% endif %}
                    
                    {% if gitStatus.behind == 0 and gitStatus.ahead == 0 and gitStatus.hasRemoteBranch %}
                      <div style="margin-bottom: 6px; color: #28a745;">
                        <span>‚úì</span> {{ _('Up to date with remote') }}
                      </div>
                    {% endif %}
                  {% else %}
                    <div style="margin-bottom: 6px; color: #ffc107;">
                      <span>‚ö†</span> {{ _('Remote branch not found') }}: {{ currentBranch }}
                    </div>
                    {% if gitStatus.hasLocalBranch and gitStatus.localCommits > 0 %}
                      <div style="margin-bottom: 6px; color: #17a2b8; font-size: 12px;">
                        <span>‚Ñπ</span> {{ _('Push will create a new remote branch') }}
                      </div>
                    {% endif %}
                  {% endif %}
                </div>
              {% else %}
                <div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid #dee2e6; color: #888;">
                  <span>‚Äî</span> {{ _('No remote repository configured') }}
                </div>
              {% endif %}
            {% else %}
              <div style="margin-bottom: 6px; color: #888;">
                <span>‚Äî</span> {{ _('No local repository') }}
              </div>
            {% endif %}
          </div>
          
          {% if gitStatus.uncommittedChanges %}
            <button type="button" id="commit-btn" class="button success expanded" style="margin-bottom: 8px; margin-top: 10px;" onclick="(function(){
              var note = window.prompt('{{ _('Enter commit message (optional)') }}', '');
              if (note === null) return;
              
              var btn = document.getElementById('commit-btn');
              var originalText = btn.textContent;
              btn.disabled = true;
              btn.textContent = '{{ _('Committing...') }}';
              
              fetch('{{ url('base_commit_branch', domainId=base.domainId, docId=base.docId, branch=currentBranch) }}', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                },
                body: JSON.stringify({ note: note || '' })
              })
              .then(response => response.json())
              .then(async data => {
                const Notification = await getNotification();
                if (data.ok) {
                  await Notification.success('{{ _('Changes committed successfully') }}');
                  setTimeout(() => window.location.reload(), 1000);
                } else {
                  await Notification.error(data.error || '{{ _('Commit failed') }}');
                  btn.disabled = false;
                  btn.textContent = originalText;
                }
              })
              .catch(async error => {
                const Notification = await getNotification();
                await Notification.error('{{ _('Commit failed') }}: ' + error.message);
                btn.disabled = false;
                btn.textContent = originalText;
              });
            })()">{{ _('Commit Changes') }}</button>
          {% endif %}
          
          {% if gitStatus.ahead > 0 %}
            <button type="button" id="push-btn" class="button warning expanded" style="margin-bottom: 8px;" onclick="(function(){
              if (!confirm('{{ _('Are you sure you want to push to GitHub?') }}')) return;
              
              var btn = document.getElementById('push-btn');
              var originalText = btn.textContent;
              btn.disabled = true;
              btn.textContent = '{{ _('Pushing...') }}';
              
              fetch('{{ url('base_github_push_branch', domainId=base.domainId, docId=base.docId, branch=currentBranch) }}', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                }
              })
              .then(response => response.json())
              .then(async data => {
                const Notification = await getNotification();
                if (data.ok) {
                  await Notification.success('{{ _('Successfully pushed to GitHub') }}');
                  setTimeout(() => window.location.reload(), 1000);
                } else {
                  await Notification.error(data.error || '{{ _('Push to GitHub failed') }}');
                  btn.disabled = false;
                  btn.textContent = originalText;
                }
              })
              .catch(async error => {
                const Notification = await getNotification();
                await Notification.error('{{ _('Push to GitHub failed') }}: ' + error.message);
                btn.disabled = false;
                btn.textContent = originalText;
              });
            })()">{{ _('Push to GitHub') }}</button>
          {% elif gitStatus.behind > 0 %}
            <button type="button" id="pull-btn" class="button alert expanded" style="margin-bottom: 8px;" onclick="(function(){
              if (!confirm('{{ _('Are you sure you want to pull from GitHub? This may overwrite local changes.') }}')) return;
              
              var btn = document.getElementById('pull-btn');
              var originalText = btn.textContent;
              btn.disabled = true;
              btn.textContent = '{{ _('Pulling...') }}';
              
              fetch('{{ url('base_github_pull_branch', domainId=base.domainId, docId=base.docId, branch=currentBranch) }}', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                }
              })
              .then(response => response.json())
              .then(async data => {
                const Notification = await getNotification();
                if (data.ok) {
                  await Notification.success('{{ _('Successfully pulled from GitHub') }}');
                  setTimeout(() => window.location.reload(), 1000);
                } else {
                  await Notification.error(data.error || '{{ _('Pull from GitHub failed') }}');
                  btn.disabled = false;
                  btn.textContent = originalText;
                }
              })
              .catch(async error => {
                const Notification = await getNotification();
                await Notification.error('{{ _('Pull from GitHub failed') }}: ' + error.message);
                btn.disabled = false;
                btn.textContent = originalText;
              });
            })()">{{ _('Pull from GitHub') }}</button>
          {% elif not gitStatus.hasRemoteBranch and gitStatus.hasLocalBranch and gitStatus.hasRemote and gitStatus.localCommits > 0 %}
            <button type="button" id="push-btn" class="button warning expanded" style="margin-bottom: 8px;" onclick="(function(){
              if (!confirm('{{ _('Are you sure you want to push to GitHub?') }}')) return;
              
              var btn = document.getElementById('push-btn');
              var originalText = btn.textContent;
              btn.disabled = true;
              btn.textContent = '{{ _('Pushing...') }}';
              
              fetch('{{ url('base_github_push_branch', domainId=base.domainId, docId=base.docId, branch=currentBranch) }}', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                }
              })
              .then(response => response.json())
              .then(async data => {
                const Notification = await getNotification();
                if (data.ok) {
                  await Notification.success('{{ _('Successfully pushed to GitHub') }}');
                  setTimeout(() => window.location.reload(), 1000);
                } else {
                  await Notification.error(data.error || '{{ _('Push to GitHub failed') }}');
                  btn.disabled = false;
                  btn.textContent = originalText;
                }
              })
              .catch(async error => {
                const Notification = await getNotification();
                await Notification.error('{{ _('Push to GitHub failed') }}: ' + error.message);
                btn.disabled = false;
                btn.textContent = originalText;
              });
            })()">{{ _('Push to GitHub') }} ({{ _('Create remote branch') }})</button>
          {% endif %}
        {% endif %}
      </div>
      
    </div>
  </div>
</div>

<script>
  // Âä†ËΩΩÂéÜÂè≤ËÆ∞ÂΩï
  async function loadHistory() {
    const historyListEl = document.getElementById('history-list');
    if (!historyListEl) return;
    
    try {
      const response = await fetch('{{ url('base_history_branch', domainId=base.domainId, docId=base.docId, branch=currentBranch) }}');
      const data = await response.json();
      const history = data.history || [];
      
      if (history.length === 0) {
        historyListEl.innerHTML = '<div style="color: #888; text-align: center; padding: 20px;">{{ _('No history yet') }}</div>';
        return;
      }
      
      historyListEl.innerHTML = history.map(entry => {
        const date = new Date(entry.timestamp);
        const timeStr = date.toLocaleString('zh-CN', { 
          year: 'numeric', 
          month: '2-digit', 
          day: '2-digit', 
          hour: '2-digit', 
          minute: '2-digit',
          second: '2-digit'
        });
        const typeIcon = entry.type === 'commit' ? 'üíæ' : 'üíø';
        const typeText = entry.type === 'commit' ? 'Êèê‰∫§' : '‰øùÂ≠ò';
        
        return `
          <div style="margin-bottom: 8px; padding: 8px; background: #fff; border: 1px solid #dee2e6; border-radius: 4px; cursor: pointer;" 
               onclick="restoreHistory('${entry.id}')"
               onmouseover="this.style.background='#f0f0f0'"
               onmouseout="this.style.background='#fff'"
               title="ÁÇπÂáªÊÅ¢Â§çÂà∞ËØ•ÂéÜÂè≤ËäÇÁÇπ">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
              <span style="font-weight: 600; font-size: 11px;">${typeIcon} ${typeText}</span>
              <span style="color: #888; font-size: 10px;">${timeStr}</span>
            </div>
            <div style="color: #666; font-size: 11px; margin-bottom: 2px;">${entry.description || 'Êó†ÊèèËø∞'}</div>
            <div style="color: #999; font-size: 10px;">${entry.username || 'unknown'}</div>
          </div>
        `;
      }).join('');
    } catch (error) {
      historyListEl.innerHTML = '<div style="color: #dc3545; text-align: center; padding: 20px;">{{ _('Failed to load history') }}</div>';
    }
  }
  
  // ÊÅ¢Â§çÂà∞ÂéÜÂè≤ËäÇÁÇπ
  async function restoreHistory(historyId) {
    if (!confirm('Á°ÆÂÆöË¶ÅÊÅ¢Â§çÂà∞ËØ•ÂéÜÂè≤ËäÇÁÇπÂêóÔºüÂΩìÂâçÊú™‰øùÂ≠òÁöÑÊõ¥ÊîπÂ∞Ü‰∏¢Â§±„ÄÇ')) return;
    
    try {
      // ÊûÑÂª∫Ê≠£Á°ÆÁöÑURLÔºåÂ∞ÜhistoryId‰Ωú‰∏∫Ë∑ØÂæÑÂèÇÊï∞
      const baseUrl = '{{ url('base_history_restore_branch', domainId=base.domainId, docId=base.docId, branch=currentBranch, historyId='__HISTORY_ID__') }}';
      const url = baseUrl.replace('__HISTORY_ID__', encodeURIComponent(historyId));
      const response = await fetch(url, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        }
      });
      const data = await response.json();
      
      if (data.success) {
        const Notification = await getNotification();
        await Notification.success('ÊÅ¢Â§çÊàêÂäüÔºåÈ°µÈù¢Â∞ÜÂà∑Êñ∞');
        setTimeout(() => window.location.reload(), 1000);
      } else {
        const Notification = await getNotification();
        await Notification.error(data.error || 'ÊÅ¢Â§çÂ§±Ë¥•');
      }
    } catch (error) {
      const Notification = await getNotification();
      await Notification.error('ÊÅ¢Â§çÂ§±Ë¥•: ' + error.message);
    }
  }
  
</script>
{% endblock %}

