{% extends "layout/basic.html" %}
{% block content %}
<div class="row">
  <div class="medium-9 columns">
    <div class="section">
      <div class="section__body">
            <ul class="supplementary list">
          <li>
            <a class="discussion-node-tag" href="{{ url('agent_domain', uid=udoc._id) }}">
              <span class="v-center icon icon-flag"></span>
              {{ _("{0}'s agent").format(udoc.uname) }}
            </a>
          </li>
          <li><h2>{{ adoc.title }}</h2></li>
          <li>
            {{ user.render_inline(udoc) }}
            @
            {{ datetimeSpan(adoc._id)|safe }}
          </li>
        </ul>
        <div class="typo richmedia topic__content" data-emoji-enabled>
          {{ adoc['content']|markdown|safe }}
        </div>

        {% if handler.user.hasPriv(PRIV.PRIV_USER_PROFILE) %}
        <!-- Chat Link Section -->
        <div class="section" style="margin-top: 20px;">
          <div class="section__body">
            <a href="{{ url('agent_chat', domainId=domainId, aid=adoc.aid) }}" class="button primary expanded">
              <span class="icon icon-comment"></span> {{ _('Chat with Agent') }}
            </a>
          </div>
        </div>
        {% endif %}
        
        <!-- Footer Section -->
        <ul class="section__footer supplementary dot list">
          {% if handler.user.hasPriv(PRIV.PRIV_EDIT_SYSTEM) or handler.user.own(adoc) %}
            <li><a href="{{ url('agent_edit', domainId=domainId, aid=adoc.aid) }}">
              <span class="icon icon-edit"></span> {{ _('Edit') }}
            </a></li>
          {% endif %}
          <li>{{ _('{0} views').format(adoc.views) }}</li>
          {% if handler.user.hasPriv(PRIV.PRIV_USER_PROFILE) %}
            <li>
              <form class="form--inline" method="post">
                <input type="hidden" name="operation" value="{% if not dsdoc['star'] %}star{% else %}unstar{% endif %}">
                <button class="star{% if dsdoc['star'] %} activated{% endif %}" type="submit">
                  <span class="starred--hide"><span class="icon icon-star--outline"></span> {{ _('Star') }}</span>
                  <span class="starred--show"><span class="icon icon-star"></span> {{ _('Unstar') }}</span>
                </button>
              </form>
            </li>
          {% endif %}
          <li><a href="{{ url('wiki_help', anchor='contact') }}">
            <span class="icon icon-warning"></span> {{ _('Report') }}
          </a></li>
        </ul>
        <!-- End of Footer Section -->
        
      </div>
    </div>
  </div>

  <div class="medium-3 columns">

    {% if handler.user.hasPriv(PRIV.PRIV_USER_PROFILE) %}
    <div class="section">
      <div class="section__header">
        <h2>{{ _('Actions') }}</h2>
      </div>
      <div class="section__body">
        <a href="{{ url('agent_edit', domainId=domainId, aid=adoc.aid) }}" class="button primary expanded">
          {{ _('Edit') }}
        </a>
      </div>
    </div>
    {% endif %}

    {% if handler.user.own(adoc) or handler.user.hasPriv(PRIV.PRIV_EDIT_SYSTEM) %}
    <div class="section">
      <div class="section__header">
        <h2 class="section__title">{{ _('API Access') }}</h2>
      </div>
      <div class="section__body">
        <div class="typo">
          {% if adoc.apiKey %}
          <p><strong>{{ _('API Key') }}:</strong></p>
          <pre class="code"><code id="api-key-display">{{ adoc.apiKey }}</code></pre>
          
          <p style="margin-top: 15px;"><strong>{{ _('API Endpoint') }}:</strong></p>
          <pre class="code"><code>{{ apiUrl }}</code></pre>
          
          <p style="margin-top: 15px;"><strong>{{ _('Usage Example') }}:</strong></p>
          <pre class="code"><code>curl -X POST {{ apiUrl }} \
  -H "X-API-Key: {{ adoc.apiKey }}" \
  -H "Content-Type: application/json" \
  -d '{"message": "Hello"}'</code></pre>
          
          <div style="margin-top: 15px;">
            <form method="post" class="form--inline" onsubmit="event.preventDefault(); deleteApiKey('{{ domainId }}', '{{ adoc.aid }}'); return false;">
              <input type="hidden" name="operation" value="deleteApiKey">
              <button type="submit" class="button danger">{{ _('Delete API Key') }}</button>
            </form>
          </div>
          {% else %}
          <p>{{ _('No API key generated yet. Click the button below to generate one.') }}</p>
          <div style="margin-top: 15px;">
            <form method="post" class="form--inline" onsubmit="event.preventDefault(); generateApiKey('{{ domainId }}', '{{ adoc.aid }}'); return false;">
              <input type="hidden" name="operation" value="generateApiKey">
              <button type="submit" class="button primary">{{ _('Generate API Key') }}</button>
            </form>
          </div>
          <div id="api-key-result" style="margin-top: 15px; display: none;"></div>
          {% endif %}
          
          {% if adoc.apiKey %}
          <p style="margin-top: 15px;"><strong>{{ _('Note') }}:</strong></p>
          <p class="note">{{ _('Keep your API key secure. You can also use Authorization: Bearer header or pass apiKey in request body.') }}</p>
          {% endif %}
        </div>
      </div>
    </div>
    {% endif %}

    <script>
    async function generateApiKey(domainId, aid) {
      try {
        const response = await fetch(`/d/${domainId}/agent/${aid}`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ operation: 'generateApiKey' }),
        });
        
        const data = await response.json();
        if (data.apiKey) {
          location.reload();
        } else {
          alert('Failed to generate API key');
        }
      } catch (error) {
        console.error('Error:', error);
        alert('Failed to generate API key');
      }
    }

    async function deleteApiKey(domainId, aid) {
      if (!confirm('{{ _("Are you sure you want to delete the API key? This action cannot be undone.") }}')) {
        return;
      }
      
      try {
        const response = await fetch(`/d/${domainId}/agent/${aid}`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ operation: 'deleteApiKey' }),
        });
        
        const data = await response.json();
        if (data.success) {
          location.reload();
        } else {
          alert('Failed to delete API key');
        }
      } catch (error) {
        console.error('Error:', error);
        alert('Failed to delete API key');
      }
    }
    </script>
    

    <div class="section">
      <div class="section__header">
        <h1 class="section__title">{{ _('Discussions') }}</h1>
      </div>
      <div class="section__body">
        <ul class="menu">
          {% if handler.user.hasPerm(perm.PERM_VIEW_DISCUSSION) %}
          <li class="menu__item">
            <a class="menu__link{% if page_name == 'discussion_node' or page_name == 'discussion_detail' %} active{% endif %}" 
              href="{{ url('discussion_node', type='agent', name=adoc.title) }}">
              <span class="icon icon-comment--text"></span> 
              {{ _('View Discussions') }}
              {% if discussionCount is defined %} ({{ discussionCount }}){% endif %}
            </a>
          </li>
          {% endif %}
          {% if handler.user.hasPriv(PRIV.PRIV_USER_PROFILE) %}
          <li class="menu__item">
            <a class="menu__link highlight" href="{{ url('discussion_create', type='agent', name=adoc.title) }}">
              <span class="icon icon-add"></span> {{ _('Create a Discussion') }}
            </a>
          </li>
          {% endif %}
        </ul>
      </div>
    </div>
  </div>
</div>
{% endblock %}
