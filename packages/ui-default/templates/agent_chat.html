{% extends "layout/basic.html" %}
{% block content %}
<script>
  {{ set(UiContext, 'domainId', domainId) }}
  {{ set(UiContext, 'aid', adoc.aid) }}
  {{ set(UiContext, 'STATUS', model.builtin.STATUS) }}
</script>

<div class="row">
  <div class="medium-9 columns">
    <div class="section">
      <div class="section__header">
        <h1 class="section__title">{{ adoc.title }} - {{ _('Chat') }}</h1>
        <div class="section__tools">
          <a href="{{ url('agent_detail', domainId=domainId, aid=adoc.aid) }}" class="button">
            <span class="icon icon-back"></span> {{ _('Back to Agent') }}
          </a>
        </div>
      </div>
      <div class="section__body">
        <div class="mcp-status-container">
          <span id="mcpStatus" class="mcp-status" data-status-url="{{ url('agent_mcp_status', domainId=domainId, aid=adoc.aid) }}">MCP: Checking...</span>
        </div>

        {% if not apiKey or apiKey == '' %}
        <div class="api-key-warning">
          <p>⚠️ {{ _('API Key not configured. Please configure AI settings in system settings') }}</p>
        </div>
        {% endif %}

        <div id="chatContainer" class="chat-container">
          <div class="chat-messages" id="chatMessages"></div>
          <div class="chat-input-container">
            <textarea id="chatInput" placeholder="{{ _('Type your message...') }}" rows="3"></textarea>
            <button id="sendButton" class="button send-button">{{ _('Send') }}</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="medium-3 columns">
    <div class="section side">
      <div class="section__header">
        <h2 class="section__title">{{ _('MCP Tools') }}</h2>
      </div>
      <div class="section__body">
        <div id="mcp-tools-sidebar">
          {# 已注释：MCP 工具状态的 WebSocket URL
          data-mcp-status-ws-url="{{ mcpStatusWsUrl|default('') }}"
          #}
          <!-- Provider MCP Servers -->
          {% if providerServers and providerServers.length > 0 %}
          <div class="mcp-category">
            <h4 style="font-size: 0.9em; margin-bottom: 8px; color: #666;">{{ _('Provider') }}</h4>
            <div id="mcp-provider-servers">
              {% for server in providerServers %}
              <div class="mcp-server-item" data-server-id="{{ server.serverId }}" data-type="provider">
                <div class="mcp-server-header" onclick="window.toggleServer && window.toggleServer('{{ server.serverId }}')">
                  <span class="mcp-server-toggle icon icon-chevron-right" id="toggle-{{ server.serverId }}"></span>
                  <span class="mcp-server-name">{{ server.name }}</span>
                  <span class="mcp-server-status" id="status-{{ server.serverId }}" data-status="{{ server.status }}">
                    {% if server.status == 'connected' %}
                    <span class="status-indicator status-online"></span>{{ _('Online') }}
                    {% else %}
                    <span class="status-indicator status-offline"></span>{{ _('Offline') }}
                    {% endif %}
                  </span>
                </div>
                <div class="mcp-server-tools" id="tools-{{ server.serverId }}" style="display: none;">
                  {% if server.tools and server.tools.length > 0 %}
                  {% for tool in server.tools %}
                  <div class="mcp-tool-item" data-tool-id="{{ tool._id }}">
                    <div class="mcp-tool-name">{{ tool.name }}</div>
                    <div class="mcp-tool-description">{{ tool.description }}</div>
                    {% if tool.inputSchema %}
                    <details class="mcp-tool-schema">
                      <summary>{{ _('View Parameters') }}</summary>
                      <pre>{{ tool.inputSchema|json }}</pre>
                    </details>
                    {% endif %}
                  </div>
                  {% endfor %}
                  {% else %}
                  <div class="mcp-tool-empty">{{ _('No tools available') }}</div>
                  {% endif %}
                </div>
              </div>
              {% endfor %}
            </div>
          </div>
          {% endif %}

          <!-- Repo MCP Servers -->
          {% if repoServers and repoServers.length > 0 %}
          <div class="mcp-category" style="margin-top: 15px;">
            <h4 style="font-size: 0.9em; margin-bottom: 8px; color: #666;">{{ _('Repo') }}</h4>
            <div id="mcp-repo-servers">
              {% for server in repoServers %}
              <div class="mcp-server-item" data-server-id="{{ server.serverId }}" data-type="repo" data-rpid="{{ server.rpid }}">
                <div class="mcp-server-header" onclick="window.toggleServer && window.toggleServer('{{ server.serverId }}')">
                  <span class="mcp-server-toggle icon icon-chevron-right" id="toggle-{{ server.serverId }}"></span>
                  <span class="mcp-server-name">{{ server.repoTitle }}</span>
                  <span class="mcp-server-status" id="status-{{ server.serverId }}" data-status="{{ server.status }}">
                    {% if server.status == 'connected' %}
                    <span class="status-indicator status-online"></span>{{ _('Online') }}
                    {% else %}
                    <span class="status-indicator status-offline"></span>{{ _('Offline') }}
                    {% endif %}
                  </span>
                </div>
                <div class="mcp-server-tools" id="tools-{{ server.serverId }}" style="display: none;">
                  {% if server.tools and server.tools.length > 0 %}
                  {% for tool in server.tools %}
                  <div class="mcp-tool-item" data-tool-id="{{ tool._id }}">
                    <div class="mcp-tool-name">{{ tool.name }}</div>
                    <div class="mcp-tool-description">{{ tool.description }}</div>
                    {% if tool.inputSchema %}
                    <details class="mcp-tool-schema">
                      <summary>{{ _('View Parameters') }}</summary>
                      <pre>{{ tool.inputSchema|json }}</pre>
                    </details>
                    {% endif %}
                  </div>
                  {% endfor %}
                  {% else %}
                  <div class="mcp-tool-empty">{{ _('No tools available') }}</div>
                  {% endif %}
                </div>
              </div>
              {% endfor %}
            </div>
          </div>
          {% endif %}

          <!-- Node MCP Servers -->
          {% if nodeServers and nodeServers.length > 0 %}
          <div class="mcp-category" style="margin-top: 15px;">
            <h4 style="font-size: 0.9em; margin-bottom: 8px; color: #666;">{{ _('Node') }}</h4>
            <div id="mcp-node-servers">
              {% for server in nodeServers %}
              <div class="mcp-server-item" data-server-id="{{ server.serverId }}" data-type="node">
                <div class="mcp-server-header" onclick="window.toggleServer && window.toggleServer('{{ server.serverId }}')">
                  <span class="mcp-server-toggle icon icon-chevron-right" id="toggle-{{ server.serverId }}"></span>
                  <span class="mcp-server-name">{{ server.name }}</span>
                  <span class="mcp-server-status" id="status-{{ server.serverId }}" data-status="{{ server.status }}">
                    {% if server.status == 'connected' %}
                    <span class="status-indicator status-online"></span>{{ _('Online') }}
                    {% else %}
                    <span class="status-indicator status-offline"></span>{{ _('Offline') }}
                    {% endif %}
                  </span>
                </div>
                <div class="mcp-server-tools" id="tools-{{ server.serverId }}" style="display: none;">
                  {% if server.tools and server.tools.length > 0 %}
                  {% for tool in server.tools %}
                  <div class="mcp-tool-item" data-tool-id="{{ tool._id }}">
                    <div class="mcp-tool-name">{{ tool.name }}</div>
                    <div class="mcp-tool-description">{{ tool.description }}</div>
                    {% if tool.inputSchema %}
                    <details class="mcp-tool-schema">
                      <summary>{{ _('View Parameters') }}</summary>
                      <pre>{{ tool.inputSchema|json }}</pre>
                    </details>
                    {% endif %}
                  </div>
                  {% endfor %}
                  {% else %}
                  <div class="mcp-tool-empty">{{ _('No tools available') }}</div>
                  {% endif %}
                </div>
              </div>
              {% endfor %}
            </div>
          </div>
          {% endif %}

          {% if (not providerServers or providerServers.length == 0) and (not nodeServers or nodeServers.length == 0) and (not repoServers or repoServers.length == 0) %}
          <p class="note">{{ _('No MCP servers available.') }}</p>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}


