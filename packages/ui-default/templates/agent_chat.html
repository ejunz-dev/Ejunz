{% extends "layout/basic.html" %}
{% block content %}
<script>
  {{ set(UiContext, 'domainId', domainId) }}
  {{ set(UiContext, 'aid', adoc.aid) }}
  {{ set(UiContext, 'STATUS', model.builtin.STATUS) }}
  {{ set(UiContext, 'mode', mode|default('list')) }}
  {{ set(UiContext, 'sessionId', sessionId|default('')) }}
  {% if recordHistory is defined %}
  {{ set(UiContext, 'recordHistory', recordHistory) }}
  {% endif %}
</script>

<div class="row">
  <div class="medium-9 columns">
    <div class="section">
      <div class="section__header">
        <h1 class="section__title">{{ adoc.title }} - {{ _('Chat') }}</h1>
        <div class="section__tools">
          {% if mode == 'chat' %}
          <a href="{{ url('agent_chat', domainId=domainId, aid=adoc.aid) }}" class="button" id="backToListBtn">
            <span class="icon icon-back"></span> {{ _('Back to Sessions') }}
          </a>
          {% else %}
          <a href="{{ url('agent_detail', domainId=domainId, aid=adoc.aid) }}" class="button">
            <span class="icon icon-back"></span> {{ _('Back to Agent') }}
          </a>
          {% endif %}
        </div>
      </div>
      <div class="section__body">
        {% if mode == 'list' %}
        <!-- Session List Mode -->
        <div id="sessionListMode">
          <div style="margin-bottom: 15px;">
            <button id="newChatBtn" class="button primary">
              <span class="icon icon-add"></span> {{ _('New Chat') }}
            </button>
          </div>
          {% if sessions and sessions.length > 0 %}
          <div class="session-list">
            {% for session in sessions %}
            <div class="session-item" data-session-id="{{ session._id.toString() }}" style="border: 1px solid #ddd; border-radius: 4px; padding: 15px; margin-bottom: 10px; cursor: pointer;">
              <div style="display: flex; justify-content: space-between; align-items: center;">
                <div style="flex: 1;">
                  <h3 style="margin: 0 0 5px 0; font-size: 1.1em;">
                    {{ session.title or ('Session ' + session._id.toString().substring(0, 8)) }}
                  </h3>
                  {% if session.lastRecord and session.lastRecord.agentMessages %}
                    {% set lastMsg = session.lastRecord.agentMessages[session.lastRecord.agentMessages.length - 1] %}
                    <p style="margin: 5px 0; color: #666; font-size: 0.9em; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                      {{ lastMsg.content|truncate(100) }}
                    </p>
                  {% endif %}
                  <div style="font-size: 0.85em; color: #999; margin-top: 5px;">
                    <span>{{ (session.recordIds|length) if session.recordIds else 0 }} {{ _('records') }}</span>
                    <span style="margin-left: 10px;">{{ datetimeSpan(session.updatedAt, false)|safe if session.updatedAt else datetimeSpan(session._id, false)|safe }}</span>
                  </div>
                </div>
                <div>
                  <span class="icon icon-chevron-right" style="color: #999;"></span>
                </div>
              </div>
            </div>
            {% endfor %}
          </div>
          {% else %}
          <div class="typo">
            <p class="text-gray">{{ _('No sessions yet. Click "New Chat" to start a conversation.') }}</p>
          </div>
          {% endif %}
        </div>
        {% endif %}
        <!-- Chat Mode (always present, hidden in list mode) -->
        <div id="chatMode" {% if mode == 'list' %}style="display: none;"{% endif %}>
          <div class="mcp-status-container">
            <span id="mcpStatus" class="mcp-status" data-status-url="{{ url('agent_mcp_status', domainId=domainId, aid=adoc.aid) }}">MCP: Checking...</span>
          </div>

          {% if not apiKey or apiKey == '' %}
          <div class="api-key-warning">
            <p>⚠️ {{ _('API Key not configured. Please configure AI settings in system settings') }}</p>
          </div>
          {% endif %}

          <div id="chatContainer" class="chat-container">
            <div class="chat-messages" id="chatMessages"></div>
            <div class="chat-input-container">
              <textarea id="chatInput" placeholder="{{ _('Type your message...') }}" rows="3"></textarea>
              <button id="sendButton" class="button send-button">{{ _('Send') }}</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="medium-3 columns">
    {% if mode == 'chat' %}
    <div class="section side">
      <div class="section__header">
        <h2 class="section__title">{{ _('MCP Tools') }}</h2>
      </div>
      <div class="section__body">
        <div id="mcp-tools-sidebar">
          {# 已注释：MCP 工具状态的 WebSocket URL
          data-mcp-status-ws-url="{{ mcpStatusWsUrl|default('') }}"
          #}
          <!-- Provider MCP Servers -->
          {% if providerServers and providerServers.length > 0 %}
          <div class="mcp-category">
            <h4 style="font-size: 0.9em; margin-bottom: 8px; color: #666;">{{ _('Provider') }}</h4>
            <div id="mcp-provider-servers">
              {% for server in providerServers %}
              <div class="mcp-server-item" data-server-id="{{ server.serverId }}" data-type="provider">
                <div class="mcp-server-header" onclick="window.toggleServer && window.toggleServer('{{ server.serverId }}')">
                  <span class="mcp-server-toggle icon icon-chevron-right" id="toggle-{{ server.serverId }}"></span>
                  <span class="mcp-server-name">{{ server.name }}</span>
                  <span class="mcp-server-status" id="status-{{ server.serverId }}" data-status="{{ server.status }}">
                    {% if server.status == 'connected' %}
                    <span class="status-indicator status-online"></span>{{ _('Online') }}
                    {% else %}
                    <span class="status-indicator status-offline"></span>{{ _('Offline') }}
                    {% endif %}
                  </span>
                </div>
                <div class="mcp-server-tools" id="tools-{{ server.serverId }}" style="display: none;">
                  {% if server.tools and server.tools.length > 0 %}
                  {% for tool in server.tools %}
                  <div class="mcp-tool-item" data-tool-id="{{ tool._id }}">
                    <div class="mcp-tool-name">{{ tool.name }}</div>
                    <div class="mcp-tool-description">{{ tool.description }}</div>
                    {% if tool.inputSchema %}
                    <details class="mcp-tool-schema">
                      <summary>{{ _('View Parameters') }}</summary>
                      <pre>{{ tool.inputSchema|json }}</pre>
                    </details>
                    {% endif %}
                  </div>
                  {% endfor %}
                  {% else %}
                  <div class="mcp-tool-empty">{{ _('No tools available') }}</div>
                  {% endif %}
                </div>
              </div>
              {% endfor %}
            </div>
          </div>
          {% endif %}

          <!-- Repo MCP Servers -->
          {% if repoServers and repoServers.length > 0 %}
          <div class="mcp-category" style="margin-top: 15px;">
            <h4 style="font-size: 0.9em; margin-bottom: 8px; color: #666;">{{ _('Repo') }}</h4>
            <div id="mcp-repo-servers">
              {% for server in repoServers %}
              <div class="mcp-server-item" data-server-id="{{ server.serverId }}" data-type="repo" data-rpid="{{ server.rpid }}">
                <div class="mcp-server-header" onclick="window.toggleServer && window.toggleServer('{{ server.serverId }}')">
                  <span class="mcp-server-toggle icon icon-chevron-right" id="toggle-{{ server.serverId }}"></span>
                  <span class="mcp-server-name">{{ server.repoTitle }}</span>
                  <span class="mcp-server-status" id="status-{{ server.serverId }}" data-status="{{ server.status }}">
                    {% if server.status == 'connected' %}
                    <span class="status-indicator status-online"></span>{{ _('Online') }}
                    {% else %}
                    <span class="status-indicator status-offline"></span>{{ _('Offline') }}
                    {% endif %}
                  </span>
                </div>
                <div class="mcp-server-tools" id="tools-{{ server.serverId }}" style="display: none;">
                  {% if server.tools and server.tools.length > 0 %}
                  {% for tool in server.tools %}
                  <div class="mcp-tool-item" data-tool-id="{{ tool._id }}">
                    <div class="mcp-tool-name">{{ tool.name }}</div>
                    <div class="mcp-tool-description">{{ tool.description }}</div>
                    {% if tool.inputSchema %}
                    <details class="mcp-tool-schema">
                      <summary>{{ _('View Parameters') }}</summary>
                      <pre>{{ tool.inputSchema|json }}</pre>
                    </details>
                    {% endif %}
                  </div>
                  {% endfor %}
                  {% else %}
                  <div class="mcp-tool-empty">{{ _('No tools available') }}</div>
                  {% endif %}
                </div>
              </div>
              {% endfor %}
            </div>
          </div>
          {% endif %}

          <!-- Node MCP Servers -->
          {% if nodeServers and nodeServers.length > 0 %}
          <div class="mcp-category" style="margin-top: 15px;">
            <h4 style="font-size: 0.9em; margin-bottom: 8px; color: #666;">{{ _('Node') }}</h4>
            <div id="mcp-node-servers">
              {% for server in nodeServers %}
              <div class="mcp-server-item" data-server-id="{{ server.serverId }}" data-type="node">
                <div class="mcp-server-header" onclick="window.toggleServer && window.toggleServer('{{ server.serverId }}')">
                  <span class="mcp-server-toggle icon icon-chevron-right" id="toggle-{{ server.serverId }}"></span>
                  <span class="mcp-server-name">{{ server.name }}</span>
                  <span class="mcp-server-status" id="status-{{ server.serverId }}" data-status="{{ server.status }}">
                    {% if server.status == 'connected' %}
                    <span class="status-indicator status-online"></span>{{ _('Online') }}
                    {% else %}
                    <span class="status-indicator status-offline"></span>{{ _('Offline') }}
                    {% endif %}
                  </span>
                </div>
                <div class="mcp-server-tools" id="tools-{{ server.serverId }}" style="display: none;">
                  {% if server.tools and server.tools.length > 0 %}
                  {% for tool in server.tools %}
                  <div class="mcp-tool-item" data-tool-id="{{ tool._id }}">
                    <div class="mcp-tool-name">{{ tool.name }}</div>
                    <div class="mcp-tool-description">{{ tool.description }}</div>
                    {% if tool.inputSchema %}
                    <details class="mcp-tool-schema">
                      <summary>{{ _('View Parameters') }}</summary>
                      <pre>{{ tool.inputSchema|json }}</pre>
                    </details>
                    {% endif %}
                  </div>
                  {% endfor %}
                  {% else %}
                  <div class="mcp-tool-empty">{{ _('No tools available') }}</div>
                  {% endif %}
                </div>
              </div>
              {% endfor %}
            </div>
          </div>
          {% endif %}

          {% if (not providerServers or providerServers.length == 0) and (not nodeServers or nodeServers.length == 0) and (not repoServers or repoServers.length == 0) %}
          <p class="note">{{ _('No MCP servers available.') }}</p>
          {% endif %}
        </div>
      </div>
    </div>
    {% endif %}
  </div>
</div>
{% endblock %}


